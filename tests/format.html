<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta charset='utf-8' />
	<meta http-equiv="X-UA-Compatible" content="chrome=1" />
	<meta name="description" content="AAS Time Series library." />
	<title>timeseries.js library</title>
	<link rel="stylesheet" href="../resources/aas.css">
	<link rel="stylesheet" href="../resources/style.css">
	<link rel="stylesheet" href="../resources/timeseries.css">
	<!-- StuQuery for DOM manipulation -->
	<script language="javascript" type="text/javascript" src="../resources/stuquery.js"></script>
	<script language="javascript" type="text/javascript" src="../resources/graph.js"></script>
	<style>
	h4 { margin-bottom: 0px; }
	.result {
		margin-bottom: 1em;
		padding: 1em;
	}
	.result:last-child {
		margin-bottom: 0px;
	}
	.result span { padding: 0 0.2em; }
	#function {
		width: 100%;
		height:8em;
		text-align:left;
		padding:0.25em;
		padding-left:2em;
		font-size:1em;
		border:0;
		line-height: 1.25em;
		overflow-x: auto;
	}
	#function, .result {
		background:	#efefef;
	}
	table {
		width: 100%;
		text-align: left;
		border-collapse: collapse;
	}
	table th { background: #444; color: #dfdfdf; }
	table th, table td { border: 1px solid #999999; padding: 0.25em 0.5em; width: 25%; }
	h3 { margin: 0px; }
	.success td, .success { background-color: rgba(100,255,100,0.25)!important; }
	.fail td, .fail { background-color: rgba(255,100,100,0.25)!important; }
	.partial td, .partial { background-color: rgba(255,255,100,0.1)!important; }
	#summary { text-align: center; padding: 0.5em; background-color: #efefef; }
	ul.links { list-style: none; margin: 0px; }
	ul.links li { display: inline-block; }
	ul.links li.ex a { padding: 0.25em 0.5em; color: inherit; text-decoration: none; }
	</style>
</head>
<body>

	<div class="msg"></div>
	<!-- HEADER -->
	<header>
		<div class="row">
			<div class="padded">
				<a id="forkme_banner" href="https://github.com/astrofrog/aas-time-series-js">Fork Me on GitHub</a>
				<h1 id="project_title">Tick formatting test</h1>
			</div>
		</div>
	</header>

	<!-- MAIN CONTENT -->
	<div class="row">
		<div class="example">
			<p>This is a test of the <code>graph</code> library tick calculations and label formatting.</p>
			<div id="summary"></div>
			<div id="graph"></div>
			
			<h2>Tick calculating and labelling function</h2>
			<p>Define the Javascript formatting function below. It should take <code>value</code> as an argument and it should return a string.</p>
			<pre>function(min,max){</pre>
			<textarea id="function"></textarea>
			<pre>}</pre>
			<h2>Output</h2>
			<div id="output"></div>
			<!-- Javascript -->
			<script>
			S(document).ready(function(){

				var tests = [
					{
						'range':{'min':'1000000','max':'1004000'},
						'output':{'min':1000000,'max':1004000,'inc':500},
						'values':["1000000","1000500","1001000","1001500","1002000","1002500","1003000","1003500","1004000","1004500"]
					},{
						'range':{'min':0.91,'max':1.42},
						'output':{'min':0.9,'max':1.5,'inc':0.1},
						'values':["0.9","1","1.1","1.2","1.3","1.4","1.5"]
					},{
						'range':{'min':0.995,'max':1.035},
						'output':{'min':0.99,'max':1.04,'inc':0.01},
						'values':["0.99","1","1.01","1.02","1.03","1.04"]
					},{
						'range':{'min':0.0000001,'max':0.000000145},
						'output':{'min':1e-7,'max':1.5e-7,'inc':1e-8},
						'values':["1e-7","1.1e-7","1.2e-7","1.3e-7","1.4e-7","1.5e-7"]
					},{
						'range':{'min':'1542651740796','max':'1542651740811'},
						'output':{'min':1542651740795,'max':1542651740815,'inc':5},
						'values':["1542651740795","1542651740800","1542651740805","1542651740810","1542651740815"]
					},{
						'range':{'min':'1542651740796','max':'1542651740811'},
						'date': true,
						'output':{'min':1542651740796,'max':1542651740812,'inc':2},
						'values':["20.796","20.798","20.8","20.802","20.804","20.806","20.808","20.81","20.812"]
					},{
						'range':{'min':'1542651740796','max':'1542651940811'},
						'date': true,
						'output':{'min':1542651720000,'max':1542651960000,'inc':60000},
						'values':["18:22","18:23","18:24","18:25","18:26"]
					},{
						'range':{'min':'1542651740796','max':'1542751740811'},
						'date': true,
						'output':{'min':1542650400000,'max':1542758400000,'inc':21600000},
						'values':["18:00","00:00","06:00","12:00","18:00","00:00"]
					},{
						'range':{'min':'1542651740796','max':'1543651740811'},
						'date': true,
						'output':{'min':1542585600000,'max':1543795200000,'inc':172800000},
						'values':["2018-11-19","2018-11-21","2018-11-23","2018-11-25","2018-11-27","2018-11-29","2018-12-01","2018-12-03"]
					},{
						'range':{'min':'1542651740796','max':'1642651740811'},
						'date': true,
						'output':{'min':1514764800000,'max':1672552800000,'inc':31557600000},
						'values':["2018","2019","2020","2021","2022","2023"]
					},{
						'range':{'min':'1542651740796','max':'2542651740811'},
						'date': true,
						'output':{'min':1262304000000,'max':2840184000000,'inc':315576000000},
						'values':["2010","2020","2030","2040","2050","2060"]
					},{
						'range':{'min':'1542651740796','max':'11542651740811'},
						'date': true,
						'output':{'min':946684800000,'max':13569465600000,'inc':3155760000000},
						'values':["2000","2100","2200","2300","2400"]
					}
				];


				var graph = new Graph(S('#graph')[0], [], {});
				var els = new Array();

				function processFunction(fn_inner){
					var customfn = false;
					var good = 0;
					var total = 0;
					var error = [];
					var o = "";
					var li = "";

					if(fn_inner){
						var fn = 'function defineAxis(min, max){ '+fn_inner+'}'
						try {
							eval(fn);
							rtn = defineAxis(0,1);
							if(typeof rtn==="object" && typeof rtn.min==="number" && typeof rtn.max==="number" && typeof rtn.inc=="number" && typeof rtn.values==="object") customfn = true;
							else{
								error.push("Function doesn't return a valid structure. Must be in the style {'max':0,'min':0,'inc':1,'values':[]}");
							}
						}catch(err){
							error.push("Can't evaluate the custom function");
						}
					}

					for(var t = 0, n = 1; t < tests.length; t++, n++){
						var ok = 0;
						var ntest = 0;
						var table = '';
						var errs = new Array();

						if(customfn){
							min = parseFloat(tests[t].range.min);
							max = parseFloat(tests[t].range.max);
							output = defineAxis(parseFloat(tests[t].range.min),parseFloat(tests[t].range.max));
							output.isDate = (tests[t].date||false);
						}else{
							graph.x.isDate = (tests[t].date||false);
							graph.defineAxis("x",parseFloat(tests[t].range.min),parseFloat(tests[t].range.max));
							output = {'min':graph.x.gmin,'max':graph.x.gmax,'inc':graph.x.inc,'isDate':graph.x.isDate};
							output.values = new Array();
							
							for(var v = output.min, i = 0; v <= output.max; v += output.inc, i++){
								if(output.isDate){
									output.values.push(graph.formatLabelDate(v));
								}else{
									try {
										output.values.push(graph.formatLabel('x',v));
									}catch(err){
										output.values.push('ERROR');
										errs.push("formatLabel failed on "+v+' due to <code>'+err+'</code>');
									}
								}
							}
						}


						compare = {'min':false,'max':false,'inc':false};
						// See how well we did
						for(var key in compare){
							total++;
							ntest++;
							if(tests[t].output){
								if(tests[t].output[key]){
									if(tests[t].output[key]==output[key]){
										ok++;
										compare[key] = true;
									}
								}
							}
						}
						if(!output.values) output.values = new Array();
						for(var i = 0, v = output.min; i < output.values.length; i++, total++, ntest++, v += output.inc){
							s = (tests[t].values[i] == output.values[i]);
							if(s) ok++;
							table += '<tr class="'+(s ? 'success':'fail')+'"><td>'+v+'</td><td>'+tests[t].values[i]+'</td><td>'+output.values[i]+'</td><td>'+(s ? '&#x2714;':'&#x274C;')+'</td></tr>';
						}

						good += ok;
						o = '<h3 id="'+n+'">Example '+n+': '+(ok > 0 && ok == ntest ? 'success':'fail')+'</h3><p>Data range is '+tests[t].range.min+' &rarr; '+tests[t].range.max+' which becomes <span class="'+(compare.min ? 'success':'fail')+'">'+output.min+'</span>'+(compare.min ? '' :' (expecting '+tests[t].output.min+')')+' &rarr; <span class="'+(compare.max ? 'success':'fail')+'">'+output.max+'</span>'+(compare.max ? '' :' (expecting '+tests[t].output.max+')')+' with an increment of <span class="'+(compare.inc ? 'success':'fail')+'">'+output.inc+'</span>'+(compare.inc ? '' :' (expecting '+tests[t].output.inc+')')+'. The axis type is <code>'+(output.isDate ? 'date':'number')+'</code>.</p><table><tr><th>Internal value</th><th>Expected</th><th>Result</th><th>Success</th></tr>'+table+'</table>';
						if(errs.length > 0){
							o += '<h4>Errors</h4><ul class="errors">';
							for(var e = 0; e < errs.length; e++) o += '<li>'+errs[e]+'</li>';
							o += '</ul>';
						}
						li += '<li class="ex '+(ok > 0 ? (ok == ntest ? 'success':'partial'):'fail')+'"><a href="#'+n+'">'+n+'</a></li>';
						els[t].html(o);
					}

				
					var summary = S('#summary');
					var html = 'Passes '+(good)+'/'+total+' tests <ul class="links">'+li+'</ul>';
					for(var e = 0; e < error.length; e++) html += '<br />'+error[e];
					summary.html(html);
					if(good==total) summary.addClass('success').removeClass('fail');
					else summary.removeClass('success').addClass('fail');
					
					// Update anchor now that we've updated the page		
					if(location.hash) document.location = location.hash;
				}
				
				// Build DOM containers
				var el = S('#output');
				for(var t = 0; t < tests.length; t++){
					if(S('#output-'+t).length==0) el.append('<div id="output-'+t+'" class="result">Test '+t+'</div>');
					els[t] = S('#output-'+t);
				}

				S('#function').on('keydown',function(){
					processFunction(this[0].value);
				});

				processFunction(S('#function')[0].value);

			});
			</script>
		</div>
	</div>

	<!-- FOOTER	-->
	<div class="row">
		<footer>
		&copy; 2018 Aperio Software / AAS
		</footer>
	</div>


</body>
</html>
