(function(root){function getJD(today){if(!today){today=new Date()}return(today.getTime()/86400000)+2440587.5}function getStyle(el,styleProp){if(typeof root==="undefined"){return}var style;var el=document.getElementById(el);if(el.currentStyle){style=el.currentStyle[styleProp]}else{if(root.getComputedStyle){style=document.defaultView.getComputedStyle(el,null).getPropertyValue(styleProp)}}if(style&&style.length===0){style=null}return style}var basedir="";TimeSeries=new function(){this.version="0.0.5";this.create=function(json,opt){return new TS(json,opt)};this.load={resources:{files:{},callbacks:[]},data:{files:{},callbacks:[]}};this.callback="";this.logging=false;var scripts=document.getElementsByTagName("script");var path=scripts[scripts.length-1].src.split("?")[0];var idx=path.lastIndexOf("/");basedir=(idx>=0)?path.substr(0,idx+1):"";var _obj=this;this.log=function(){if(this.logging){var args=Array.prototype.slice.call(arguments,0);if(console&&typeof console.log==="function"){console.log("TimeSeries",args)}}return this};this.filesLoaded=function(fs){this.log("filesLoaded",fs,this.load.data);var n=0;for(var d=0;d<fs.length;d++){if(this.load.data.files[fs[d]]&&this.load.data.files[fs[d]].loaded){n++}}return(n==fs.length)};this.loadFromDataFile=function(f,attr,fn){this.log("loadFromDataFile",f,attr,fn);attr.file=f;if(!this.load.data.files[f]){this.load.data.files[f]={loaded:false,callbacks:[]};this.load.data.files[f].callbacks.push({fn:fn,attr:attr});this.log("loading data",f);S().ajax(f,{dataType:"csv","this":this,file:f,success:function(d,attr){d=d.replace(/[\n\r]$/,"");var cb=this.load.data.files[attr.file].callbacks;this.log("CALLBACKS",attr.file,cb);for(var i=0;i<cb.length;i++){this.load.data.files[cb[i].attr.file].data=d;this.load.data.files[cb[i].attr.file].loaded=true;this.log("DATA ",cb[i].attr.dataset.name,this.load.data.files[cb[i].attr.file]);if(typeof cb[i].fn==="function"){cb[i].fn.call(cb[i].attr["this"],this.load.data.files[cb[i].attr.file].data,cb[i].attr)}}}})}else{if(!this.load.data.files[f].loaded){this.load.data.files[f].callbacks.push({fn:fn,attr:attr})}else{if(typeof fn==="function"){fn.call(attr["this"],this.load.data.files[f].data,attr)}}}};this.loadResources=function(files,attr,callback){this.log("loadResources",files);if(typeof files==="string"){files=[files]}this.load.resources.callbacks.push({callback:callback,attr:attr});function checkAndGo(files,t){var got=0;for(var f=0;f<files.length;f++){if(TimeSeries.load[t].files[files[f]].loaded){got++}}_obj.log("checkAndGo",got,files.length,TimeSeries.load[t].callbacks);if(got==files.length){for(var c=TimeSeries.load[t].callbacks.length-1;c>=0;c--){_obj.log("Processing callback "+c+" for "+t,TimeSeries.load[t].callbacks);TimeSeries.load[t].callbacks[c].callback.call((TimeSeries.load[t].callbacks[c].attr["this"]||TimeSeries),{data:TimeSeries.load[t].callbacks[c].attr});TimeSeries.load[t].callbacks.pop()}}}for(var i=0;i<files.length;i++){if(!_obj.load.resources.files[files[i]]){_obj.log("loading resource",files[i]);_obj.log("start loading "+files[i]+" is ",_obj.load.resources.files[files[i]]);_obj.load.resources.files[files[i]]={loaded:false};_obj.loadCode(files[i],function(e){_obj.load.resources.files[e.url].loaded=true;_obj.log("loaded resource "+e.url);checkAndGo(files,"resources")})}else{_obj.log("current state of "+files[i]+" is ",_obj.load.resources.files[files[i]])}}return _obj};this.loadCode=function(url,callback){var el;this.log("loadCode",url,callback);if(url.indexOf(".js")>=0){el=document.createElement("script");el.setAttribute("type","text/javascript");el.src=url}else{if(url.indexOf(".css")>=0){el=document.createElement("style");el.setAttribute("rel","stylesheet");el.setAttribute("type","text/css");el.setAttribute("href",url)}}if(el){el.onload=function(){callback.call(_obj,{url:url})};document.getElementsByTagName("head")[0].appendChild(el)}return _obj};return this};var freeExports=typeof exports=="object"&&exports&&!exports.nodeType&&exports;var freeModule=freeExports&&typeof module=="object"&&module&&!module.nodeType&&module;if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){root.TimeSeries=TimeSeries;define(function(){return TimeSeries})}else{if(freeModule){(freeModule.exports=TimeSeries).TimeSeries=TimeSeries;freeExports.TimeSeries=TimeSeries}else{root.TimeSeries=TimeSeries}}function TS(json,opt){if(!opt){opt={}}this.attr=opt;if(typeof json==="object"){this.json=json}else{if(typeof json==="string"){this.file=json}}this.logging=opt.logging||false;if(typeof opt.showaswego==="undefined"){opt.showaswego=false}this.log("TS",json);this.options={xaxis:{title:"Time",log:false,fit:true},yaxis:{title:"y-axis",log:false},grid:{hoverable:true,clickable:true,color:"#888888"},labels:{color:"#000000"},fit:false,tooltip:{theme:"aas-theme"},showaswego:opt.showaswego};this.datasets=[];this.directory="";for(var o in opt){if(o=="directory"){this[o]=opt[o]}if(o=="fit"){this.options[o]=opt[o]}if(o=="tooltip"){this.options[o]=opt[o]}}if(this.json){this.processJSON(json)}return this}TS.prototype.log=function(){if(this.logging){var args=Array.prototype.slice.call(arguments,0);if(console&&typeof console.log==="function"){console.log("TS",args)}}return this};TS.prototype.processJSON=function(d){this.json=d;this.log("processJSON",d,this.json);if(d.width){this.options.width=d.width}if(d.height){this.options.height=d.height}if(d.padding){this.options.padding=d.padding}if(d.axes){for(var a=0;a<d.axes.length;a++){var dim="";if(d.axes[a].orient=="bottom"){dim="xaxis"}if(d.axes[a].orient=="left"){dim="yaxis"}if(dim){for(var p in d.axes[a]){this.options[dim][p]=d.axes[a][p]}}}}this.options.logging=true;return this};TS.prototype.postProcess=function(){this.log("postProcess",this);if(this.options.fit){this.options.width=this.initializedValues.w;this.options.height=this.initializedValues.h}this.options.logging=this.logging;this.options.xaxis.mode="time";this.graph=new Graph(this.el,[],this.options);this.graph.canvas.container.append('<div class="loader"><div class="spinner"><div class="rect1 seasonal"></div><div class="rect2 seasonal"></div><div class="rect3 seasonal"></div><div class="rect4 seasonal"></div><div class="rect5 seasonal"></div></div></div>');if(this.json){this.loadDatasets(this.json.data)}return this};TS.prototype.initialize=function(e,callback){this.log("initialize",e);if(typeof callback==="function"){this.callback=callback}var el=S(e);if(el.length==0){return this}this.el=e;this.log("load",e,el,this.options.fit);var f=el.attr("vega-src");if(f){this.file=f}if(!this.file){this.file=""}if(typeof this.file!=="string"){return this}if(typeof this.initializedValues==="undefined"){this.initializedValues={w:e.clientWidth,h:e.clientHeight}}var _obj=this;if(typeof Graph==="undefined"&&typeof Graph!=="function"){TimeSeries.loadResources(basedir+"graph.js",{"this":this,el:e},function(ev){this.log("ev",ev,this);this.log("loadedResources");this.initialize(ev.data.el)})}else{if(this.file){var idx=this.file.lastIndexOf("/");this.directory=(idx>=0)?this.file.substr(0,idx+1):"";S().ajax(this.file,{dataType:"json","this":this,cache:true,success:function(d,attr){this.processJSON(d);this.postProcess();return this}})}else{this.postProcess();return this}}return this};TS.prototype.loadDatasets=function(data){this.log("loadDatasets",data);if(!data){return this}this.datasets={};var n=data.length;var f="";var files=[];for(var i=0;i<n;i++){files.push(this.directory+data[i].url)}this.log("files",files,TimeSeries.filesLoaded(files));for(var j=0;j<n;j++){TimeSeries.loadFromDataFile(files[j],{"this":this,dataset:data[j],files:files},function(csv,attr){var json=CSV2JSON(csv,attr.dataset.format.parse);this.datasets[attr.dataset.name]=json;this.update(attr.dataset.name);if(TimeSeries.filesLoaded(attr.files)){this.loaded()}})}return this};TS.prototype.update=function(datasetID){var id,mark;this.olddatasetsused=this.datasetsused;this.datasetsused="";this.log("update",datasetID);var ev=function(str,datum){return eval(str)};function updateProperties(d,event){var dest={size:"props",shape:"props",fill:"props",fillOpacity:"props",stroke:"props",strokeOpacity:"props",strokeWidth:"props",strokeCap:"props",strokeDash:"props",width:"props",height:"props",tooltip:"props"};datum=d.data;for(var p in event){if(dest[p]&&dest[p]=="props"){if(event[p].value){if(d.props.symbol){d.props.symbol[p]=event[p].value}if(d.props.format){d.props.format[p]=event[p].value}}if(event[p].signal){if(event[p].signal){try{d.props[p]=looseJsonParse(event[p].signal,d.data)}catch(e){_obj.log("Error",d.data,event[p])}if(p=="tooltip"&&typeof d.props[p]==="object"){str="<table>";for(var i in d.props[p]){if(typeof d.props[p][i]!="undefined"){str+="<tr><td>"+i+":</td><td>"+d.props[p][i]+"</td></tr>"}}d.props[p]=str+"</table>"}}}}else{if(event[p].field&&datum[event[p].field]){datum[p]=datum[event[p].field]}if(event[p].signal){try{datum[p]=ev.call(datum,event[p].signal,datum)}catch(e){_obj.log("Error",datum,event[p])}}}}return d}var _obj=this;for(var m=0;m<this.json.marks.length;m++){id="";mark=this.json.marks[m];if(mark.from.data){id=mark.from.data}if(this.datasets[id]){this.datasetsused+=id}if(this.datasets[id]&&id==datasetID){var dataset;if(mark.type=="symbol"){dataset={data:clone(this.datasets[id]),title:id,type:mark.type,symbol:{show:true},rect:{show:false},lines:{show:false},clickable:true,css:{"font-size":"0.8em","background-color":"#000000"}}}else{if(mark.type=="rect"){dataset={data:clone(this.datasets[id]),title:id,type:mark.type,symbol:{show:false},rect:{show:true},lines:{show:false},clickable:true,css:{"font-size":"0.8em","background-color":"#000000"}}}else{if(mark.type=="line"){dataset={data:clone(this.datasets[id]),type:mark.type,symbol:{show:false},rect:{show:false},title:id,lines:{show:true},clickable:true,css:{"font-size":"0.8em","background-color":"#000000"}}}}}if(dataset){if(mark.encode&&mark.encode.hover){dataset.hoverable=true;if(mark.encode.hover.fill){dataset.css["background-color"]=mark.encode.hover.fill.value}}dataset.encode=mark.encode;if(mark.encode.enter){dataset.enter=function(datum,event){return updateProperties(datum,event)}}if(mark.encode.update){dataset.update=function(datum,event){return updateProperties(datum,event)}}if(mark.encode.hover){dataset.hover=function(datum,event){return updateProperties(datum,event)}}this.graph.addDataset(dataset,m)}else{this.log("No dataset built for "+id,mark)}}}if(this.datasetsused!=this.olddatasetsused&&this.attr.showaswego){this.graph.updateData()}return this};TS.prototype.loaded=function(){this.log("loaded",this.attr.showaswego,this.graph.data);if(this.attr.showaswego==false){this.graph.updateData()}this.graph.canvas.container.find(".loader").remove();if(typeof this.callback==="function"){this.callback.call(this)}return this};function CSVToArray(CSV_string,delimiter){delimiter=(delimiter||",");var pattern=new RegExp(("(\\"+delimiter+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+delimiter+"\\r\\n]*))"),"gi");var rows=[[]];var matches=false;while(matches=pattern.exec(CSV_string)){var matched_delimiter=matches[1];if(matched_delimiter.length&&matched_delimiter!==delimiter){rows.push([])}var matched_value;if(matches[2]){matched_value=matches[2].replace(new RegExp('""',"g"),'"')}else{matched_value=matches[3]}rows[rows.length-1].push(matched_value)}return rows}function CSV2JSON(data,parse){if(typeof data==="string"){data=CSVToArray(data)}var line,datum,header,types,rows;var newdata=new Array();var formats=new Array();var header=new Array();formats=new Array(data[0].length);header=new Array(data[0].length);for(var j=0;j<data[0].length;j++){header[j]=data[0][j];formats[j]=parse[header[j]]||"string"}for(var i=1;i<data.length;i++){if(!data[i]||data[i]==""){continue}datum={};for(var j=0;j<data[i].length;j++){if(formats[j]!="string"){if(formats[j]=="number"){data[i][j]=parseFloat(data[i][j])}else{if(formats[j]=="date"){data[i][j]=new Date(data[i][j].replace(/^"/,"").replace(/"$/,""))}else{if(formats[j]=="boolean"){if(data[i][j]=="1"||data[i][j]=="true"||data[i][j]=="Y"){data[i][j]=true}else{if(data[i][j]=="0"||data[i][j]=="false"||data[i][j]=="N"){data[i][j]=false}else{data[i][j]=null}}}}}}datum[header[j]]=data[i][j]}newdata.push(datum)}return newdata}function looseJsonParse(obj,datum){var fns="function zeroPad(d){ d = d+''; if(d.length==1){ d = '0'+d;} return d; };function timeFormat(t,f){var d = new Date(t);var ds = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];var dl = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];var ms = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];var ml = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];return f.replace(/%a/g,ds[d.getDay()]).replace(/%Y/g,d.getFullYear()).replace(/%a/g,dl[d.getDay()]).replace(/%b/g,ms[d.getMonth()]).replace(/%B/g,ml[d.getMonth()]).replace(/%d/g,(d.getDate().length==1 ? '0':'')+d.getDate()).replace(/%m/,(d.getMonth()+1)).replace(/%H/,zeroPad(d.getUTCHours())).replace(/%M/,zeroPad(d.getUTCMinutes())).replace(/%S/,zeroPad(d.getUTCSeconds())).replace(/%L/,d.getUTCMilliseconds());}";return Function('"use strict";'+fns+" return ("+obj+")")()}function clone(hash){var json=JSON.stringify(hash);var object=JSON.parse(json);return object}root.AASTimeSeriesEmbed=function(el,json,opt){var ts=TimeSeries.create(json,opt);ts.initialize(S(el)[0]);return}})(this);function Te(g,d,j,f){var c="<html><head>"+d+'</head><body><pre><code class="json">',h="</code></pre>"+j+"</body></html>",b=window.open("");b.document.write(c+g+h),b.document.title=Ae[f]+" JSON Source"}dateFormat="jd";function formatDate(b,a){if(!a){a=dateFormat}var c=new JD(b,"unix");if(a=="jd"){return c.valueOf().toFixed(3)}else{if(a=="mjd"){return c.toMJD()}else{if(a=="iso"){return c.toISOString()}else{return c}}}}function JD(b,d,e){epoch=2440587.5;var c=86400;var g=c*1000000;if(typeof b==="number"){if(typeof d!=="undefined"){if(d=="unix"){this.val=a(b)}else{if(d=="epoch"&&e){this.val=a((new Date(e)).getTime()+b*1000)}else{if(d=="mjd"){b+=2400000.5}}}}if(!this.val){var h=Math.floor(b);this.val=[h,(b-h)*g]}}else{this.val=a(b)}var f=this;this.valueOf=function(){return f.val[0]+f.val[1]/g};this.toUNIX=function(){return((f.val[0]-epoch)*g+f.val[1])/1000};this.toMJD=function(){return(f.val[0]+(f.val[1]/g)-2400000.5)};this.toISOString=function(){return(new Date(f.toUNIX())).toISOString()};function a(i){var k=rem=ms=0;if(typeof i==="undefined"){i=new Date();ms=i.getTime()}else{if(typeof i==="string"){var j=0;i=i.replace(/(\:[0-9]{2})\.([0-9]+)/,function(l,o,n){j=parseFloat("0."+n);return o});ms=(new Date(i)).getTime();ms+=j*1000}else{ms=i*1000}}k=Math.floor(ms/g);rem=(ms-k*g)+g/2;return[k+epoch-0.5,rem]}return this};