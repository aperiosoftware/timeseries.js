(function(l){var j="";function g(){this.version="0.0.18";this.create=function(t,s){if(!s){s={}}if(typeof s.logging!=="boolean"){s.logging=this.log.logging}if(typeof s.logtime!=="boolean"){s.logtime=this.log.logtime}return new d(t,s)};this.load={resources:{files:{},callbacks:[]},data:{files:{},callbacks:[]}};this.callback="";this.log=new Logger({id:"TimeSeries",logging:(location.search.indexOf("logging=true")>0),logtime:(location.search.indexOf("logtime=true")>0)});var q=document.getElementsByTagName("script");var r=q[q.length-1].src.split("?")[0];var p=r.lastIndexOf("/");j=(p>=0)?r.substr(0,p+1):"";if(console){console.log("%ctimeseries.js v"+this.version+"%c","font-weight:bold;font-size:1.25em;","")}this.loadFromDataFile=function(u,s,t){this.log.message("loadFromDataFile",u,s,t);s.file=u;if(!this.load.data.files[u]){this.log.time("loadFromDataFile "+u);this.load.data.files[u]={loaded:false,callbacks:[]};if(!this.load.counter){this.load.counter=0}if(!this.load.data.files[u].name){this.load.data.files[u].id="file-"+(this.load.counter++)}this.load.data.files[u].callbacks.push({fn:t,attr:s});this.log.message("loading data",u);var v=s["this"];v.updateMessage("main"+this.load.data.files[u].id,"Loading "+s.dataset.name+"...");S().ajax(u,{dataType:"text","this":this,file:u,id:this.load.data.files[u].id,success:function(z,x){z=z.replace(/[\n\r]$/,"");var w=this.load.data.files[x.file].callbacks;this.log.message("CALLBACKS",x.file,w);v.updateMessage("main"+x.id,"");for(var y=0;y<w.length;y++){this.load.data.files[w[y].attr.file].data=z;this.load.data.files[w[y].attr.file].loaded=true;if(typeof w[y].fn==="function"){w[y].fn.call(w[y].attr["this"],this.load.data.files[w[y].attr.file].data,w[y].attr)}}this.log.message("loaded from data file "+x.file);this.log.time("loadFromDataFile "+x.file)},error:function(z,x){var w=this.load.data.files[x.file].callbacks;for(var y=0;y<w.length;y++){w[y].attr["this"].error("Failed to load",x.file,z)}}})}else{if(!this.load.data.files[u].loaded){this.load.data.files[u].callbacks.push({fn:t,attr:s})}else{if(typeof t==="function"){t.call(s["this"],this.load.data.files[u].data,s)}}}};return this}TimeSeries=new g();function d(q,p){if(!p){p={}}this.attr=p;if(typeof q==="object"){this.json=q;this.vega=JSON.parse(JSON.stringify(q))}else{if(typeof q==="string"){this.file=q}}this.log=new Logger({logging:(p.logging||false),logtime:(p.logtime||false),id:"TS"});if(typeof p.showaswego==="undefined"){p.showaswego=false}this.log.message("TS",q);this.progress={datasets:{old:"",used:""},update:{todo:0,done:0}};this.options={xaxis:{title:"Time",log:false,fit:true},yaxis:{title:"y-axis",log:false},grid:{hoverable:true,clickable:true,color:"#888888"},labels:{color:"#000000"},fit:false,tooltip:{theme:"aas-theme"},showaswego:p.showaswego};this.xformats={auto:{title:"Auto",types:{absolute:true,relative:true},scale:1,formatLabel:function(u,s){var t=(s.input=="seconds"||s.input=="")?u:f(u,s.input,"seconds");return{str:s.niceDate(t,s.spacing)}}},relative:{title:"Relative date",types:{relative:true},scale:1,formatLabel:function(u,B){var x,w,G,H,A,C,z,y,t,F,E,D;x=typeof u;if(x=="string"||x=="number"){u=Num(u)}if(u==null){return{str:""}}w=(u.gte(0))?1:-1;G=u.abs();H=u.abs();if(B){D=Math.abs(B.ticks[B.ticks.length-1].value)}else{D=H}if(typeof D.toValue==="function"){D=D.toValue()}F=["y","d","h","m","s"];A={y:86400*365.25,d:86400,h:3600,m:60,s:1};C="";E={};for(z=0;z<F.length;z++){y=F[z];t=A[y];E[y]=Number(H.div(t).round(0,0));H=H.minus(E[y]*t)}if(H.gt(0)){E.f=H.toString();E.f=E.f.substr(E.f.indexOf("."))}C="";if(E.y>0){C=E.y+"y"}if(E.d>0){C+=(C?" ":"")+E.d+"d"}if(E.h>0||E.m>0||G.gt(A.d)){C+=(C?" ":"")+h(E.h,2)+":"}if(E.m>0||E.h>0||G.gt(A.d)){C+=""+h(E.m,2)}if(E.s>0||E.f){C+=(D>A.m||D>A.h||G.gt(A.d)?":":"")+(D>A.s?h(E.s,2):E.s)}if(E.f){C+=E.f}return{str:(w<0?"-":"")+C}}},locale:{title:"Locale",scale:1,types:{absolute:true},formatLabel:function(t,s){return{str:(new Date(f(t,s.input,"unix"))).toLocaleString()}}},iso:{title:"ISO8601",scale:1,types:{absolute:true},formatLabel:function(u,s){var w={str:"?"};var t=f(u,s.input,s.output);if(s.spacing.name=="days"){t=t.replace(/^([0-9]{4}-[0-9]{2}-[0-9]{2}).*/,function(v,x){return x})}w.str=t.replace(/\.0+Z/,"Z");return w}},jd:{title:"Julian date",scale:86400,types:{absolute:true},formatLabel:function(t,s){return{str:f(t,s.input,s.output)+""}}},mjd:{title:"Modified Julian date",scale:86400,types:{absolute:true},formatLabel:function(t,s){return{str:f(t,s.input,s.output)+""}}},tjd:{title:"Truncated Julian date",scale:86400,types:{absolute:true},formatLabel:function(t,s){return{str:f(t,s.input,s.output)+""}}},unity:{title:"Phase (unity)",types:{phase:true},convert:function(t,s){if(s=="degrees"){return Num(t).div(360).toValue()}else{if(s=="radians"){return Num(t).div(2).toValue()}}return t},formatLabel:function(t,s){return{str:t.toString()}}},degrees:{title:"Phase (degrees)",types:{phase:true},convert:function(t,s){if(s=="unity"){t=Num(t).times(360).toValue()}else{if(s=="radians"){t=Num(t).times(180).toValue()}}return t},spacing:function(s){if(s>300){return 90}if(s>200){return 60}if(s>100){return 30}else{return 0}},formatLabel:function(t,s){return{str:t.toString()+"°"}}},radians:{title:"Phase (radians)",types:{phase:true},convert:function(t,s){if(s=="unity"){return Num(t).times(2).toValue()}else{if(s=="degrees"){return Num(t).div(180).toValue()}}return t},formatLabel:function(t,s){return{str:t.toString()+"π"}}}};this.datasets=[];this.directory="";for(var r in p){if(p[r]){if(r=="directory"){this[r]=p[r]}if(r=="fit"||r=="tooltip"){this.options[r]=p[r]}}}if(this.json){this.processJSON(q)}return this}d.prototype.processJSON=function(r){this.json=i(r);this.vega=i(r);this.log.message("processJSON",r,this.json);if(r.width){this.options.width=r.width}if(r.height){this.options.height=r.height}if(r.padding){this.options.padding=r.padding}if(r.axes){for(var p=0;p<r.axes.length;p++){var q="";if(r.axes[p].orient=="bottom"){q="xaxis"}if(r.axes[p].orient=="left"){q="yaxis"}if(q){this.options[q]=r.axes[p]}}}return this};d.prototype.initialize=function(s,t){this.log.message("initialize",s);if(typeof t==="function"){this.callback=t}if(!s){this.log.error(s,t)}var q=S(s);if(q.length==0){this.log.error("No DOM element to attach to",s);return this}this.el=s;var r=q.attr("vega-src");if(r){this.file=r}if(!this.file){this.file=""}if(typeof this.file!=="string"){return this}if(typeof this.initializedValues==="undefined"){this.initializedValues={w:s.clientWidth,h:s.clientHeight}}if(this.file){var p=this.file.lastIndexOf("/");this.directory=(p>=0)?this.file.substr(0,p+1):"";S().ajax(this.file,{dataType:"json","this":this,cache:true,success:function(v,u){if(!v){this.error("JSON is invalid",u.url)}else{this.processJSON(v);this.postProcess()}},error:function(v,u){this.error("Unable to load configuration",u.url,v)}})}else{this.postProcess();return this}return this};d.prototype.postProcess=function(){this.log.message("postProcess",this);this.log.time("postProcess");var y,q,u,p,t,z,v,w,A;if(this.json){var r,x;if(!this.json._extend){this.json._extend={}}if(!this.json._views){this.json._views=[]}z=0;for(t=0;t<this.json.marks.length;t++){if(!this.json.marks[t].name){this.json.marks[t].name="fake-id-"+z;this.log.warning("No name for mark "+t+" so naming it "+this.json.marks[t].name)}z++}if(this.json._extend.marks){for(t=0;t<this.json._extend.marks.length;t++){if(!this.json._extend.marks[t].name){this.json._extend.marks[t].name="fake-id-"+z;this.log.warning("No name for mark "+t+" so naming it "+this.json._extend.marks[t].name)}z++}}r=false;for(t=0;t<this.json._views.length;t++){if(this.json._views[t].name=="default"){r=true;x=i(this.json._views[t])}}if(!r){x={name:"default",title:(this.json.title||"Default"),description:(this.json.description||"The initial view"),markers:[],}}if(!x.scales){x.scales=i(this.json.scales)}if(!x.axes){x.axes=i(this.json.axes)}if(!x._extend){x._extend=i(this.json._extend)}if(!r){for(t=0;t<this.json.marks.length;t++){x.markers.push({name:this.json.marks[t].name,include:true,visible:true})}this.json._views.unshift(x)}this._view=x}if(this.options.fit){this.options.width=this.initializedValues.w;this.options.height=this.initializedValues.h}this.options.logging=this.log.logging;this.options.logtime=this.log.logtime;this.options.scrollWheelZoom=true;if(this.json.scales){for(y=0;y<this.json.axes.length;y++){for(t=0;t<this.json.scales.length;t++){if(this.json.axes[y].scale==this.json.scales[t].name){q=(this.json.axes[y].orient=="left"?"yaxis":"xaxis");this.options[q].type=(this.json.scales[t].type||(q=="xaxis"?"utc":"linear"));this.options[q].padding=(this.json.scales[t].padding||0);if(this.json.scales[t].range){this.options[q].range=this.json.scales[t].range}if(this.json.scales[t].domain){this.options[q].domain=i(this.json.scales[t].domain);for(u=0;u<this.options[q].domain.length;u++){if(this.options[q].domain[u].signal){this.options[q].domain[u]=e(this.options[q].domain[u].signal)}}}}}if(this._view._extend.scales){for(A=0;A<this._view._extend.scales.length;A++){if(this.json.axes[y].scale==this._view._extend.scales[A].name){q=(this.json.axes[y].orient=="left"?"yaxis":"xaxis");this.options[q].highprecision=(this._view._extend.scales[A].highprecision||false)}}}}}this.graph=new Graph(this.el,this.options);p=S(this.el);w='<div class="loader"><div class="spinner">';for(t=1;t<6;t++){w+='<div class="rect'+t+' seasonal"></div>'}w+="</div></div>";p.addClass("timeseries").append(w);v=this;this.makeMenu();if(this.json){this.loadDatasets(this.json.data)}this.log.time("postProcess");return this};d.prototype.updateMessage=function(t,r,p,s){var q=S(this.el).find(".loader");if(!t){q.html("");return this}if(!this.message){this.message={}}t=this.el.getAttribute("id")+"-"+t;if(!this.message[t]){q.append('<div id="'+t+'"><div class="loader-message"></div></div>');q=q.find("#"+t);this.message[t]={el:q,message:q.find(".loader-message")}}if(r||(typeof p==="number"&&p<=100)){if(this.message[t].message.length>0){this.message[t].message[0].innerHTML=r}if(typeof p==="number"&&p<=100){if(!this.message[t].progress){this.message[t].el.append('<div class="progressbar"><div class="progress-inner"></div></div>');this.message[t].progress=this.message[t].el.find(".progress-inner")}this.message[t].progress.css({width:p+"%"});if(s){this.message[t].progress.css({background:s})}}}else{this.message[t].el.remove()}return this};d.prototype.makeMenu=function(){var r,u,q,t,p,s;r=S(this.el);u=r.attr("id");if(r.find(".menuholder").length==0){s=[{key:"views",title:"Views",html:'<ol class="views"></ol>'},{key:"layers",title:"Marker layers",html:'<ol class="layers"></ol>',on:true},{key:"config",title:"Options",html:'<div class="row"><button class="fullscreen icon" title="Toggle fullscreen">'+k("fit")+'</button><button class="autozoom">Reset view</button></div><div class="row"><button class="fontup">A&plus;</button><button class="fontreset">A</button><button class="fontdn">A&minus;</button></div>'},{key:"save",title:"Save",html:'<div class="row"><button class="savepng" data="white">Save as PNG</button><button class="savepng">Save as transparent PNG</button><button class="savevega">Save as JSON (VEGA-compatible)</button><button class="editvega">Open selected view in VEGA</button></div>'},{key:"about",title:"About",html:'<p>Figure produced with the <a href="https://aperiosoftware.github.io/timeseries.js/">AAS timeseries.js</a> package version '+TimeSeries.version+".</p>"}];t="";p="";for(q=0;q<s.length;q++){t+='<li class="submenu-'+s[q].key+'"><button '+(s[q].on?'class="on" ':"")+'data="submenu-'+s[q].key+'" title="'+s[q].title+'">'+k(s[q].key,"white")+"</button></li>";p+=(s[q].html?'<div class="menu-panel submenu-'+s[q].key+(s[q].on?" on":"")+'">'+s[q].html+"</div>":"")}t+="<li></li>";r.prepend('<div class="menuholder"><input type="checkbox" id="'+u+'_hamburger" class="hamburger"><label for="'+u+'_hamburger" class="hamburger">'+k("menu","white")+'<span class="nv">Toggle menu (if not visible)</span></label><menu class="timeseries-actions-wrapper"><ul class="submenu">'+t+"</ul>"+p+"</menu></div>");for(q=0;q<s.length;q++){if(s[q].on){r.find("submenu-"+s[q].key).addClass("on")}}r.find(".menuholder").on("mouseover",function(){S(".graph-tooltip").css({display:"none"})});r.find("#"+u+"_hamburger").on("click",{me:this},function(w){var v=(this[0].checked?0:-1);this.parent().find("menu button, menu a").attr("tabIndex",v)});r.find("button.fullscreen").on("click",{g:this.graph},function(v){v.data.g.toggleFullScreen()});r.find("button.autozoom").on("click",{g:this.graph},function(v){v.data.g.zoom()});r.find("button.fontup").on("click",{g:this.graph},function(v){v.data.g.scaleFont(+1)});r.find("button.fontdn").on("click",{g:this.graph},function(v){v.data.g.scaleFont(-1)});r.find("button.fontreset").on("click",{g:this.graph},function(v){v.data.g.scaleFont(0)});r.find("button.savevega").on("click",{me:this},function(v){v.data.me.save("vega")});r.find("button.editvega").on("click",{me:this},function(v){v.data.me.save("vegaeditor")});r.find("button.savepng").on("click",{me:this},function(v){v.data.me.save("png",{background:S(v.currentTarget).attr("data")})});r.find(".submenu button").on("click",{el:r},function(x){x.data.el.find(".on").removeClass("on");var w=S(x.currentTarget);var v=w.attr("data");w.addClass("on");x.data.el.find(".menu-panel."+v).addClass("on")})}return this};d.prototype.loadDatasets=function(u){this.log.message("loadDatasets",u);this.log.time("loadDatasets");if(!u){return this}this.updateMessage("main","Loading data...");if(u.length==0){S(this.el).find(".loader").html("&#9888; No data defined");return this}this.datasets={};var v,t,s,r,q,p;v=u.length;t="";s=[];this.progress.datasets={todo:v,done:0};r=function(z,w){var x;var y="json";if(w&&w.dataset&&w.dataset.format&&w.dataset.format.type=="csv"){y="csv"}if(y=="csv"){x=m(z,w.dataset.format.parse)}else{if(y=="json"){x=z[0]}}this.datasets[w.dataset.name]={json:x,parse:w.dataset.format.parse};this.datasets[w.dataset.name][y]=z;this.progress.datasets.done++;this.log.message("loaded dataset",w.dataset.name);if(this.progress.datasets.done==this.progress.datasets.todo){this.processDatasets()}};for(q=0;q<v;q++){if(u[q].url){s.push(this.directory+u[q].url)}}this.log.message("files",s);for(q=0;q<v;q++){if(u[q].values){r.call(this,u[q].values,{dataset:u[q],files:s})}}for(p=0;p<s.length;p++){TimeSeries.loadFromDataFile(s[p],{"this":this,dataset:u[p],files:s},r)}this.updateMessage("main","");this.log.time("loadDatasets");return this};d.prototype.updateLayerMenu=function(){var E,D,z,t,r,B,y,C,x,F,v,G,L,s,I,K,A,H,u,J,q;r=this.graph.canvas.container.find(".layers");r.find("li").remove();s={};I={};for(E in this.graph.marks){if(this.graph.marks[E]){z=S(this.el).attr("id")+"_"+E;L=this.graph.marks[E].desc;if(this.graph.marks[E].include){if(typeof s[L]==="undefined"){s[L]=[]}s[L].push(E)}}}D=0;for(L in s){if(s[L]){if(typeof s[L]!=="undefined"){z=S(this.el).attr("id")+"_"+D;G=this.graph.marks[s[L][0]];r.append('<li><input type="checkbox" checked="checked" id="'+z+'" data="'+L+'" /><label for="'+z+'"><span class="key" style="background-color:'+G.format.fill+";"+(G.type=="area"&&G.format.fillOpacity?"opacity:"+G.format.fillOpacity+";":"")+'">?</span>'+L+"</label></li>");B=r.find("#"+z);y=B.parent();C=y.find(".key");B.on("change",{me:this,k:s[L]},function(N){var M,w,p;M=N.data.me.graph;for(w=0;w<N.data.k.length;w++){p=N.data.k[w];M.marks[p].show=!M.marks[p].show}M.redraw({update:true,cancelable:false});if(this.parent().find("input")[0].checked){this.parent().removeClass("inactive")}else{this.parent().addClass("inactive")}}).on("focus",{layers:r},function(p){p.data.layers.find("li").removeClass("on").removeClass("selected");this.parent().addClass("on")});r.on("mouseover",{layers:r},function(p){p.data.layers.find(".selected").removeClass("selected")});I[s[L][0]]=B.parent();v=false;for(E=0;E<s[L].length;E++){if(["symbol","rect","line","rule","text","area"].indexOf(G.type)>=0){v=true}}if(v&&C.length==1){t=window.getComputedStyle(C[0]);x=parseInt(t.width);F=parseInt(t.height);C.html('<canvas style="width:'+x+"px;height:"+F+'px;"></canvas>')}if(y.find("canvas").length==1){H=y.find("canvas")[0];x=parseInt(y.find("canvas").css("width"));F=parseInt(y.find("canvas").css("height"));A=H.getContext("2d");K=window.devicePixelRatio;H.width=x*K;H.height=F*K;A.scale(K,K);A.clearRect(0,0,x,F);A.fillStyle="#ffffff";A.rect(0,0,x,F);A.fill();for(E=0;E<s[L].length;E++){G=this.graph.marks[s[L][E]];if(G.include){C.css({"background-color":"none"});this.graph.setCanvasStyles(A,G.mark[0]);if(G.type=="symbol"){this.graph.drawShape(i(G.mark[0]),{ctx:A,x:x/2,y:F/2})}else{if(G.type=="rect"){if(G.mark[0].props.x1&&G.mark[0].props.x2&&G.mark[0].props.y1&&G.mark[0].props.y2){this.graph.drawRect(i(G.mark[0]),{ctx:A,x1:0,y1:0,x2:x,y2:F})}else{this.graph.drawRect(i(G.mark[0]),{ctx:A,x1:x/2,y1:0,x2:x/2,y2:F})}}else{if(G.type=="area"){this.graph.drawRect(i(G.mark[0]),{ctx:A,x1:0,y1:0,x2:x,y2:F})}else{if(G.type=="line"){A.beginPath();A.moveTo(0,F/2);A.lineTo(x,F/2);A.lineWidth=(G.encode.enter.strokeWidth.value||0.8);A.stroke()}else{if(G.type=="rule"){A.beginPath();A.lineWidth=(G.encode.enter.strokeWidth.value||1);if(!G.data[0].x2){G.data[0].x2=i(G.data[0].x)}if(!G.data[0].y2){G.data[0].y2=i(G.data[0].y)}if(G.data[0].y.value==G.data[0].y2.value){A.moveTo(0,F/2+0.5);A.lineTo(x,F/2+0.5)}else{if(G.data[0].x.value==G.data[0].x2.value){A.moveTo(x/2+0.5,0);A.lineTo(x/2+0.5,F)}else{A.moveTo(0,0);A.lineTo(x,F)}}A.stroke()}else{if(G.type=="text"){this.graph.drawTextLabel("T",x/2,F/2,{ctx:A,format:{align:"center",baseline:"middle"}})}}}}}}}}}q=false;J=false;for(E=0;E<s[L].length;E++){if(this.graph.marks[s[L][E]].include){q=true}if(this.graph.marks[s[L][E]].show){J=true}}u=r.find("#"+z).parent();u.css({display:(q?"block":"none")});if(J){u.removeClass("inactive")}else{u.addClass("inactive")}D++}}}this.graph.on("hoverpoint",{lookup:I,layers:r},function(w){w.data.layers.find("li").removeClass("selected");if(w.matches.length==0){return}for(var p=0;p<w.matches.length;p++){if(w.data.lookup[w.matches[p].series]){w.data.lookup[w.matches[p].series].addClass("selected")}}});return this};d.prototype.getViews=function(){var p,r,q;p=[];q=this.json._views;for(r=0;r<q.length;r++){p.push({title:(q[r].title||""),name:(q[r].name||""),description:(q[r].description||"")})}return p};d.prototype.setView=function(v,x){var w,u,A,B,y,t,q,F,D,C,r,E,p,z;u=this.json;if(typeof v!=="number"){z=JSON.stringify(v);for(t=0;t<u._views.length;t++){if(JSON.stringify(u._views[t])==z){v=t;continue}}if(typeof v!=="number"){this.log.error("Invalid view number provided: "+v);return this}}if(typeof v!=="number"){this.log.error("Invalid view index provided: "+v);return this}if(v>=u._views.length){this.log.error("The maximum index is "+(u._views.length-1)+"");return this}for(t=0;t<u._views.length;t++){u._views[t].active=(v==t)}A=i(u._views[v]);q={};for(B=0;B<u.axes.length;B++){if(A.scales){for(F=0;F<A.scales.length;F++){if(u.axes[B].scale==A.scales[F].name){r=(u.axes[B].orient=="left"?"yaxis":"xaxis");if(typeof q[r]!=="object"){q[r]={}}q[r].type=(r=="xaxis"?"utc":"linear");q[r].padding=0;if(A.scales[F]){if(typeof A.scales[F].type!=="undefined"){q[r].type=A.scales[F].type}if(typeof A.scales[F].padding!=="undefined"){q[r].padding=A.scales[F].padding}}if(A.scales[F].range||u._views[0].scales[F].range){q[r].range=i(A.scales[F].range||u._views[0].scales[F].range)}if(u._views[0].scales[F].domain||A.scales[F].domain){q[r].domain=i(A.scales[F].domain||u._views[0].scales[F].domain);for(y=0;y<q[r].domain.length;y++){if(q[r].domain[y].signal){q[r].domain[y]=e(q[r].domain[y].signal)}}}}}}if(A.axes){r=(u.axes[B].orient=="left"?"yaxis":"xaxis");q[r].title=(typeof A.axes[B].title!=="undefined"?A.axes[B].title:"")}}this._view=A;w=this.graph;w.setOptions(q);if(A.markers){for(t in w.marks){if(w.marks[t]){E=-1;w.marks[t].include=false;for(F=0;F<A.markers.length;F++){if(w.marks[t].name==A.markers[F].name){E=F;w.marks[t].include=true;w.marks[t].show=A.markers[F].visible}}}}}else{this.log.warning("No markers provided for view."+(A.marks?' You may have accidentally used "marks" as the key.':""))}this.updateLayerMenu();this.updateOptionsMenu();p=w.canvas.container.find(".views");D=p.find("li");for(t=0;t<D.length;t++){C=S(D[t]);if(v==t){C.addClass("selected").find("input").attr("checked","checked")}else{C.removeClass("selected").find("input").attr("checked","")}}w.updateData(x);return this};d.prototype.updateViewMenu=function(){var r,q,s,v,p,u,t;t="abcdefghijklmnopqrstuvwxyz";s=this.graph.canvas.container.find(".views");p=this.graph.canvas.container.find(".submenu-views");if(this.json._views.length<2){s.css({display:"none"});p.css({display:"none"});return this}else{s.css({display:""});p.css({display:""})}u=0;for(r=0;r<this.json._views.length;r++){if(this.json._views[r].active){u=this.json._views[r].active}}this.json._views[u].active=true;for(r=0;r<this.json._views.length;r++){v=S(this.el).attr("id")+"-view-"+r;if(s.find("#"+v).length==0){s.append("<li "+(this.json._views[r].active?' class="selected"':"")+'><input type="radio"'+(this.json._views[r].active?' checked="checked"':"")+' id="'+v+'" name="'+S(this.el).attr("id")+'-view" data="'+r+'" /><label for="'+v+'" title="'+this.json._views[r].description+'"><span style="font-family:monospace;">'+t.substr(r,1).toUpperCase()+".</span> "+this.json._views[r].title+"</label></li>");q=s.find("#"+v);q.on("change",{me:this,id:v,i:r,el:s},function(w){w.data.me.setView(w.data.i)}).on("focus",{el:s},function(w){w.data.el.find("li").removeClass("on");this.parent().addClass("on")})}}return this};d.prototype.updateOptionsMenu=function(){var q=S(this.el);var p=q.attr("id");if(q.find("#"+p+"_axisformat").length>0){q.find("#"+p+"_axisformat").parent().remove()}if(this._view._extend&&this._view._extend.scales){var v,t,r,y,x,u,w;for(y=0;y<this._view._extend.scales.length;y++){if(this._view._extend.scales[y].name=="xscale"){t="absolute";if(this._view._extend.scales[y].input=="phase"){t="phase"}else{if(this._view._extend.scales[y].input=="unity"){t="phase"}else{if(this._view._extend.scales[y].input=="radians"){t="phase"}else{if(this._view._extend.scales[y].input=="degrees"){t="phase"}else{if(this._view._extend.scales[y].input=="seconds"){t="relative"}}}}}if(t=="phase"){v=(this._view._extend.scales[y].output||"unity");x="Phase format"}else{v=(this._view._extend.scales[y].output||"auto");x="Date format"}u='<div class="row"><label for="'+p+'_axisformat">'+x+': </label><select id="'+p+'_axisformat">';w=false;for(r in this.xformats){if(this.xformats[r]&&this.xformats[r].types[t]){u+='<option value="'+r+'"'+(r==v?' selected="selected"':"")+">"+this.xformats[r].title+"</option>";if(v&&this.xformats[v]&&r==v){this.setAxisFormat("x",v)}if(r==v){w=true}}}if(!w){this.log.error(v+" is not an available format",this.xformats)}u+="</select></div>";q.find(".menu-panel.submenu-config").append(u);q.find("#"+p+"_axisformat").on("change",{me:this},function(s){s.data.me.setAxisFormat("x",this[0].value,false)})}}}return this};d.prototype.setAxisFormat=function(t,q,u){var p="";if(this._view&&this._view._extend.scales){for(var r=0;r<this._view._extend.scales.length;r++){if(this._view._extend.scales[r].name=="xscale"){p=this._view._extend.scales[r].input}}}if(this.graph){if(this.xformats[q]){this.graph[t].units=p;this.graph.setAxisFormat(t,q,this.xformats);this.graph.defineAxis(t,this.graph[t].min,this.graph[t].max).redraw(u)}else{if(!this.xformats[p]){this.log.error("Input format "+p+" is not a known format")}if(!this.xformats[q]){this.log.error("Output format "+q+" is not a known format")}}}return this};d.prototype.processDatasets=function(){this.log.message("processDatasets",this.attr.showaswego,this.graph.marks);this.log.time("processDatasets");var v,r,u,t,z,w,q,s,x;if(!this.progress.marks){this.progress.marks={todo:0,done:0,mark:{}}}q=[this.json.marks];if(this.json._extend.marks){q.push(this.json._extend.marks)}for(t=0,s=0;t<q.length;t++){for(v=0;v<q[t].length;v++){if(!q[t][v].name){this.log.error("No name for "+q[t][v].title+" ("+v+")")}else{this.progress.marks.mark[q[t][v].name]={done:-1,todo:0}}s++}}this.progress.datasets.old=this.progress.datasets.used;x=this;function y(G,C){var H,F;var A={size:"props",shape:"props",fill:"props",fillOpacity:"props",stroke:"props",strokeOpacity:"props",strokeWidth:"props",strokeCap:"props",strokeDash:"props",width:"props",height:"props",tooltip:"props",font:"props",fontSize:"props",fontWeight:"props",fontStyle:"props",baseline:"props",align:"props",dx:"props",angle:"props",limit:"props"};if(!G){x.log.message("updateProps fail",G,C);return}datum=G.data;for(var E in C){if(C[E]){if(A[E]&&A[E]=="props"){if(typeof C[E].value!=="undefined"){if(G.props.symbol){G.props.symbol[E]=C[E].value}if(G.props.format){G.props.format[E]=C[E].value}}}else{if(typeof datum[E]==="undefined"){datum[E]=i(C[E])}if(C[E].field){if(typeof C[E].field==="string"){if(typeof datum[C[E].field]!=="undefined"){G.data[E]=datum[C[E].field]}else{x.log.error('The field "'+C[E].field+'" ('+E+"-axis) seems to be missing.",i(G),C)}}else{if(typeof C[E].field==="object"){G.data[E]=i(C[E])}}}if(typeof C[E].value!=="undefined"){if(C[E].format&&C[E].format=="date"){datum[E].value=(new Date(C[E].value)).getTime()/1000}else{datum[E].value=C[E].value}}}if(C[E].signal){H=A[E]||"data";if(typeof G[H][E]==="undefined"){G[H][E]={}}try{G[H][E].value=e(C[E].signal,datum)}catch(D){x.log.error(G.data,C[E])}if(E=="tooltip"){if(typeof G.props[E].value==="object"){F="<table>";for(var B in G.props[E].value){if(typeof G.props[E].value[B]!=="undefined"){F+="<tr><td>"+B+":</td><td>"+G.props[E].value[B]+"</td></tr>"}}G.props[E]=F+"</table>"}else{G.props[E]=G.props[E].value}}}}}return G}function p(D,B,H,A){var G="";var C=true;if(H.from&&H.from.data){if(typeof D.datasets[H.from.data]==="undefined"){D.log.error("Data source "+H.from.data+" doesn't seem to exist.");C=false}G=H.from.data;if(D.datasets[G]){D.progress.datasets.used+=G}}if((!G||D.datasets[G]||!C)&&!D.graph.marks[B]){var F=H.description||"Markers "+(B+1);var E={title:G,id:G,name:(H.name||""),desc:F,type:H.type,interactive:(typeof H.interactive==="boolean"?H.interactive:true),css:{"background-color":"#000000"},include:(typeof H.include==="boolean"?H.include:true)};if(H.type=="symbol"){E.symbol={show:true}}else{if(H.type=="rect"){E.rect={show:true}}else{if(H.type=="line"){E.lines={show:true}}else{if(H.type=="rule"){E.rule={show:true}}else{if(H.type=="area"){E.area={show:true}}else{if(H.type=="text"){E.text={show:true}}}}}}}if(D.datasets[G]){E.data=i(D.datasets[G].json);E.parse=D.datasets[G].parse}else{if(G&&!D.datasets[G]){D.log.error("No dataset for "+H.name)}E.data=[{props:{x:0,y:0,x2:0,y2:0}}];E.parse={}}if(E){if(H.encode&&H.encode.hover){E.hoverable=true}E.encode=H.encode;if(H.encode.enter){E.enter=function(I,J){return y(I,J)}}if(H.encode.update){E.update=function(I,J){return y(I,J)}}if(H.encode.hover){E.hover=function(I,J){return y(I,J)}}E.clip=(H.clip||false);D.graph.addMarks(E,B,H,A);if(D.datasets[G]){D.datasets[G].added=true}}else{D.log.message("No dataset built for "+G,H)}}return D}for(r in this.datasets){if(this.datasets[r]&&!this.datasets[r].data){this.datasets[r].data=this.datasets[r].json}}this.graph.addDatasets(this.datasets);this.progress.marks.todo=this.json.marks.length+(this.json._extend.marks?this.json._extend.marks.length:0);z=function(A){this.progress.marks.done++;this.progress.marks.mark[A.name].done=A.i;this.progress.marks.mark[A.name].todo=A.total;this.log.message("Processed "+A.name,this.progress.marks.mark[A.name]);this.updateMessage(A.name,"");if(this.attr.showaswego){this.graph.updateData()}if(this.progress.marks.done==this.progress.marks.todo){this.finalize()}};w=function(B){this.progress.marks.mark[B.mark.name].done=B.i;this.progress.marks.mark[B.mark.name].todo=B.total;var A="";if(B.mark.encode&&B.mark.encode.update){if(B.mark.encode.update.fill){A=B.mark.encode.update.fill.value}if(!A&&B.mark.encode.update.stroke){A=B.mark.encode.update.stroke.value}}this.updateMessage(B.mark.name,"Processing "+(B.mark.description||B.mark.name),100*B.i/B.total,A);return this};this.updateMessage("main","");for(t=0;t<this.json.marks.length;t++){u=i(this.json.marks[t]);if(this.progress.marks.mark[u.name].done<=0){this.progress.marks.mark[u.name].done=0;p(this,t,u,{"this":this,success:z,progress:w})}}if(this.json._extend.marks){for(t=0;t<this.json._extend.marks.length;t++){u=this.json._extend.marks[t];u.include=false;p(this,t+this.json.marks.length+t,i(u),{"this":this,success:z,progress:w})}}for(t in this.graph.marks){if(this.graph.marks[t]){for(v=0;v<this._view.markers.length;v++){if(this.graph.marks[t].name==this._view.markers[v].name){if(!this._view.markers[v].visible){this.graph.marks[t].show=false}}}}}if(this.progress.datasets.used!=this.progress.datasets.old&&this.attr.showaswego){this.graph.updateData()}this.log.time("processDatasets");return this};d.prototype.finalize=function(){this.log.message("finalize",this.attr.showaswego,this.graph.marks);this.updateMessage("main","");function p(q){this.graph.canvas.container.find(".loader").remove();this.updateLayerMenu();this.updateViewMenu();this.updateOptionsMenu();if(typeof this.callback==="function"){this.callback.call(this)}}if(this.attr.showaswego==false){this.graph.updateData({callback:p,self:this})}else{p(this)}return this};d.prototype.save=function(z,x){if(typeof Blob!=="function"){return this}var v,w,E,A,p,t,q;p={type:"text/text",file:(this.file?this.file.replace(/.*\//g,""):"timeseries.json")};if(!x){x={}}function y(H){var s=new Blob([H],{type:p.type});function F(I){document.body.removeChild(I.target)}var G=document.createElement("a");G.download=p.file;G.innerHTML="Download File";if(window.webkitURL!=null){G.href=window.webkitURL.createObjectURL(s)}else{G.href=window.URL.createObjectURL(s);G.onclick=F;G.style.display="none";document.body.appendChild(G)}G.click()}if(z=="vega"||z=="vegaeditor"){q=i(this.vega);for(v=0;v<q.data.length;v++){delete q.data[v].url;t="json";if(this.datasets[q.data[v].name].csv){t="csv"}q.data[v].values=this.datasets[q.data[v].name][t]}if(z=="vegaeditor"){A=this._view;var B=[];var u={};var D,r;for(r=0;r<A.markers.length;r++){D=false;for(E=0;E<this.json.marks.length;E++){if(!u[A.markers[r].name]&&this.json.marks[E].name==A.markers[r].name){B.push(i(this.json.marks[E]));u[A.markers[r].name]=true}}if(!u[A.markers[r].name]&&this.json._extend&&this.json._extend.marks){for(E=0;E<this.json._extend.marks.length;E++){if(!u[A.markers[r].name]&&this.json._extend.marks[E].name==A.markers[r].name){B.push(i(this.json._extend.marks[E]));u[A.markers[r].name]=true}}}}q.marks=B;if(A.scales){q.scales=A.scales}if(A.axes){q.axes=A.axes}if(A.title){q.title=A.title}delete q._extend;delete q._views}w=JSON.stringify(q)}if(z=="vega"){p.type="text/json";p.file=(this.file?this.file.replace(/.*\//g,""):(x.file||"timeseries.json"));y(w)}if(z=="vegaeditor"){var C=window.open("https://vega.github.io/editor/#/","VEGA","");setTimeout(function(){C.postMessage({mode:"vega",spec:w,config:{axisY:{minExtent:30}},renderer:"svg"},"https://vega.github.io")},1000)}if(z=="png"){if(x&&x.background){this.graph.background=x.background;this.graph.clear().drawAxes().resetDataStyles().drawData(false)}p.type="image/png";p.file=(x.file||"timeseries.png");this.graph.canvas.c.toBlob(y,p.type);if(x){this.graph.background="";this.graph.clear().drawAxes().resetDataStyles().drawData(false)}}return this};d.prototype.error=function(r,p,q){this.log.error(r,p,q);if(S(this.el).find(".loader").length==0){S(this.el).html('<div class="loader"><div class="spinner"></div></div>').css({position:"relative",width:"100%",height:"200px"})}if(S(this.el).find(".spinner").length>0){S(this.el).find(".loader").html("&#9888; "+r);this.remove()}S(this.el).find(".loader").append("<br />"+p+"");return this};d.prototype.remove=function(){S(this.el).find(".menuholder").remove();S(this.el).find(".canvasholder").remove();return{}};function k(q,r){var p={menu:'<path style="fill:%COLOUR%;fill-opacity: 0.8;" d="M 5,6 l 22,0 0,4 -22,0 0,-4 M 5,14 l 22,0 0,4 -22,0 0,-4 M 5,22 l 22,0 0,4 -22,0 0,-4 " />',fit:'<path style="fill:%COLOUR%" d="M 0,12 L0,0 12,0 12,4 6,4 12,10 10,12 4,6 4,12 M20,0 L 32,0 32,12 28,12 28,6 22,12 20,10 26,4 20,4 20,0 M 20,32 L20,28 26,28 20,22 22,20 28,26 28,20 32,20, 32,32 20,32 M 12,32 L 0,32 0,20 4,20 4,26 10,20 12,22 6,28 12,28 12,32" />',layers:'<path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 16,6 l 12,6.5 -12,6.5 -12,-6.5Z" /><path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 16,10.5 l 12,6.5 -12,6.5 -12,-6.5 Z" /><path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 16,15 l 12,6.5 -12,6.5 -12,-6.5 Z" />',views:'<path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 5,5 l 10,0 0,10 -10,0 0,-2 4,0 0,-2.5 2,0 0,2.5 1,0 0,-5 -1,-1 -2,0 -1,1 3,0 0,1.5 -2,0 0,-1.5 -1,0 0,5 -3,0Z M 17,5 l 10,0 0,10 -10,0 0,-2 6,0 1,-1 0,-1 -1,-1 1,-1 0,-1 -1,-1 -2,0 0,1 2,0 0,1 -0.5,0.5 -1.5,0 0,1 1.5,0 0.5,0.5 0,1 -2,0 0,-5 -1,0 0,6 -3,0Z M 5,17 l 10,0 0,10 -10,0 0,-2 4,0 3,0 0,-1 -3,0 0,-4 3,0 0,-1 -3,0 -1,1 0,4 1,1 -4,0Z M 17,17 l 10,0 0,10 -10,0 0,-2 6,0 1,-1 0,-4 -1,-1 -3,0 0,1 3,0 0,4 -2,0 0,-4 -1,0 0,5 -3,0Z" />',config:'<path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 13.971 4.5996 L 13.377 7.6992 L 13.453 7.6992 A 8.661 8.661 0 0 0 12.008 8.291 L 9.4785 6.5 L 6.5781 9.4004 L 8.3926 11.865 A 8.661 8.661 0 0 0 7.707 13.551 L 7.707 13.4 L 4.6074 13.9 L 4.6074 18 L 7.707 18.5 L 7.707 18.361 A 8.661 8.661 0 0 0 8.3945 20.033 L 6.5781 22.5 L 9.4785 25.4 L 12.01 23.609 A 8.661 8.661 0 0 0 13.395 24.189 L 13.971 27.199 L 18.033 27.199 L 18.547 24.215 A 8.661 8.661 0 0 0 20.014 23.621 L 22.529 25.4 L 25.43 22.5 L 23.635 20.059 A 8.661 8.661 0 0 0 24.289 18.496 L 27.369 18 L 27.369 13.9 L 24.283 13.402 A 8.661 8.661 0 0 0 23.631 11.848 L 25.43 9.4004 L 22.529 6.5 L 20.01 8.2832 A 8.661 8.661 0 0 0 18.564 7.6836 L 18.033 4.5996 L 13.971 4.5996 z M 15.988 10.828 A 5.0719 5.0719 0 0 1 21.061 15.9 A 5.0719 5.0719 0 0 1 15.988 20.973 A 5.0719 5.0719 0 0 1 10.916 15.9 A 5.0719 5.0719 0 0 1 15.988 10.828 z" />',save:'<path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 6,26 l 20,0 0,-6 -6,0 -4,3 -4,-3 -6,0 Z M 16,20 l 8,-8 -5,0 0,-6 -6,0 0,6 -5,0" />',about:'<path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 16,24 m -3,0 c 0,-4 6,-4 6,0 c 0,4 -6,4 -6,0 Z M 13,19 l 6,0 0,-4 c 6,0 6,-11 -3,-11 c -3,0 -8,2 -8,8 l 4,0 c 2,-10 11,0 2,2Z" />'};return'<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">'+(p[q]||"").replace(/%COLOUR%/g,(r||"black"))+"</svg>"}function c(v,p){p=(p||",");var u=new RegExp(("(\\"+p+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+p+"\\r\\n]*))"),"gi");var t=[[]];var s=false;while(s=u.exec(v)){var r=s[1];if(r.length&&r!==p){t.push([])}var q;if(s[2]){q=s[2].replace(new RegExp('""',"g"),'"')}else{q=s[3]}t[t.length-1].push(q)}return t}function m(t,v){if(typeof t==="string"){t=c(t)}var q,p,w,r,s;var u=[];p=new Array(t[0].length);w=new Array(t[0].length);for(r=0;r<t[0].length;r++){w[r]=t[0][r];p[r]=v[w[r]]||"string"}for(s=1;s<t.length;s++){if(!t[s]||t[s]==""){continue}q={};for(r=0;r<t[s].length;r++){if(p[r]=="number"){q[w[r]]=parseFloat(t[s][r])}else{q[w[r]]=t[s][r]}}u.push(q)}return u}function h(p,q){if(!q){q=2}p=p+"";while(p.length<q){p="0"+p}return p}var o="function zeroPad(d,n){ if(!n){ n = 2;} d = d+''; while(d.length < n){ d = '0'+d; } return d; };";o+="function timeFormat(t,f){ var d,micros,ds,dl,m,ms,ml; d = new Date(t*1000); micros = ''; m = (t+'').match(/\\.[0-9]{3}([0-9]+)/);if(m && m.length==2){ micros = m[1]; }; ds = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; dl = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']; ms = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; ml = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return f.replace(/%a/g,ds[d.getDay()]).replace(/%Y/g,d.getFullYear()).replace(/%a/g,dl[d.getDay()]).replace(/%b/g,ms[d.getMonth()]).replace(/%B/g,ml[d.getMonth()]).replace(/%d/g,(d.getDate().length==1 ? '0':'')+d.getDate()).replace(/%m/,(d.getMonth()+1)).replace(/%H/,zeroPad(d.getUTCHours())).replace(/%M/,zeroPad(d.getUTCMinutes())).replace(/%S/,zeroPad(d.getUTCSeconds())).replace(/%L/, (zeroPad(d.getUTCMilliseconds(),3)+micros).replace(/([0-9])0+$/,function(m,p1){ return p1; }));};";o+="function datetime(y,m,d,h,mn,sc,ms){ return (new Date(y+'-'+zeroPad(m+1,2)+'-'+(typeof d==='number' ? zeroPad(d,2):'01')+(typeof h==='number' ? 'T'+(zeroPad(h,2)+':'+(typeof mn==='number' ? zeroPad(mn,2)+(typeof sc==='number' ? ':'+zeroPad(sc,2)+(ms ? '.'+zeroPad(ms,3):''):''):'00'))+'Z':''))).valueOf()/1000; }";o+="function date(d){ return (new Date(d)).getTime()/1000; }";function e(r,q){if(typeof q==="object"){for(var p in q){if(typeof q[p]=="object"&&q[p].type=="Num"){q[p]=(typeof q[p].toValue==="function")?q[p].toValue():q[p].v}}}return Function('"use strict";'+o+" return ("+r+")")()}function i(p){return JSON.parse(JSON.stringify(p))}l.AASTimeSeriesEmbed=function(r,q,p){var s=TimeSeries.create(q,p);s.initialize(S(r)[0]);return};function f(r,q,s){if(typeof r==="number"){r=Num(r)}var p=new n(r,q);if(s=="jd"){return p.toJD()}else{if(s=="mjd"){return p.toMJD()}else{if(s=="tjd"){return p.toTJD()}else{if(s=="unix"){return p.toUNIX()}else{if(s=="seconds"){return p.toSeconds()}else{if(s=="iso"){return p.toDate().toISOString()}}}}}}return 0}function n(q,p){this.epoch={jd:2440587.5,mjd:2400000.5,tjd:2440000.5};this.d2ms=86400000;if(typeof q==="number"){q=Num(q)}if(p=="jd"){this.jd=q}if(p=="mjd"){this.jd=q.plus(this.epoch.mjd)}if(p=="tjd"){this.jd=q.plus(this.epoch.tjd)}if(p=="unix"){this.unix=q}if(p=="iso"||p=="locale"||!p){this.unix=q.times(1000)}this.toJD=function(){if(this.jd){return this.jd.toValue()}if(this.unix){return this.unix.div(this.d2ms).plus(this.epoch.jd).toValue()}return 0};this.toUNIX=function(){if(this.unix){return this.unix.toValue()}if(this.jd){return this.jd.minus(this.epoch.jd).times(this.d2ms).toValue()}return 0};this.toSeconds=function(){if(this.unix){return this.unix.div(1000).toValue()}if(this.jd){return this.jd.minus(this.epoch.jd).times(this.d2ms).div(1000).toValue()}return 0};this.toMJD=function(){if(this.unix){this.jd=this.unix.div(this.d2ms).plus(this.epoch.jd)}if(this.jd){return this.jd.minus(this.epoch.mjd).toValue()}else{return 0}};this.toTJD=function(){if(this.unix){this.jd=this.unix.div(this.d2ms).plus(this.epoch.jd)}if(this.jd){return this.jd.minus(this.epoch.tjd).toValue()}else{return 0}};this.toDate=function(){if(this.jd){return new Date(this.toUNIX())}if(this.unix){return new Date(this.unix.toValue())}return new Date()};return this}l.TimeSeries=TimeSeries})(window||this);var a,b;