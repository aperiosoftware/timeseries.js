(function(j){var h="";function e(){this.version="0.0.16";this.create=function(r,q){if(!q){q={}}if(typeof q.logging!=="boolean"){q.logging=this.log.logging}if(typeof q.logtime!=="boolean"){q.logtime=this.log.logtime}return new b(r,q)};this.load={resources:{files:{},callbacks:[]},data:{files:{},callbacks:[]}};this.callback="";this.log=new Logger({id:"TimeSeries",logging:(location.search.indexOf("logging=true")>0),logtime:(location.search.indexOf("logtime=true")>0)});var o=document.getElementsByTagName("script");var p=o[o.length-1].src.split("?")[0];var n=p.lastIndexOf("/");h=(n>=0)?p.substr(0,n+1):"";if(console){console.log("%ctimeseries.js v"+this.version+"%c","font-weight:bold;font-size:1.25em;","")}this.loadFromDataFile=function(t,q,r){this.log.message("loadFromDataFile",t,q,r);q.file=t;if(!this.load.data.files[t]){this.log.time("loadFromDataFile "+t);this.load.data.files[t]={loaded:false,callbacks:[]};if(!this.load.counter){this.load.counter=0}if(!this.load.data.files[t].name){this.load.data.files[t].id="file-"+(this.load.counter++)}this.load.data.files[t].callbacks.push({fn:r,attr:q});this.log.message("loading data",t);var u=q["this"];u.updateMessage("main"+this.load.data.files[t].id,"Loading "+q.dataset.name+"...");S().ajax(t,{dataType:"text","this":this,file:t,id:this.load.data.files[t].id,success:function(y,w){y=y.replace(/[\n\r]$/,"");var v=this.load.data.files[w.file].callbacks;this.log.message("CALLBACKS",w.file,v);u.updateMessage("main"+w.id,"");for(var x=0;x<v.length;x++){this.load.data.files[v[x].attr.file].data=y;this.load.data.files[v[x].attr.file].loaded=true;if(typeof v[x].fn==="function"){v[x].fn.call(v[x].attr["this"],this.load.data.files[v[x].attr.file].data,v[x].attr)}}this.log.message("loaded from data file "+w.file);this.log.time("loadFromDataFile "+w.file)},error:function(y,w){var v=this.load.data.files[w.file].callbacks;for(var x=0;x<v.length;x++){v[x].attr["this"].error("Failed to load",w.file,y)}}})}else{if(!this.load.data.files[t].loaded){this.load.data.files[t].callbacks.push({fn:r,attr:q})}else{if(typeof r==="function"){r.call(q["this"],this.load.data.files[t].data,q)}}}};return this}TimeSeries=new e();function b(p,n){if(!n){n={}}this.attr=n;if(typeof p==="object"){this.json=p;this.vega=JSON.parse(JSON.stringify(p))}else{if(typeof p==="string"){this.file=p}}this.log=new Logger({logging:(n.logging||false),logtime:(n.logtime||false),id:"TS"});if(typeof n.showaswego==="undefined"){n.showaswego=false}this.log.message("TS",p);this.progress={datasets:{old:"",used:""},update:{todo:0,done:0}};this.options={xaxis:{title:"Time",log:false,fit:true},yaxis:{title:"y-axis",log:false},grid:{hoverable:true,clickable:true,color:"#888888"},labels:{color:"#000000"},fit:false,tooltip:{theme:"aas-theme"},showaswego:n.showaswego};this.xformats={auto:{title:"Auto",absolute:true,relative:true,scale:1,formatLabel:function(t,o){var r=(o.input=="seconds")?t:d(t,o.input,"seconds");return{str:o.niceDate(r,o.spacing)}}},relative:{title:"Relative date",relative:true,scale:1,formatLabel:function(r,z){var u,t,E,F,y,A,x,w,o,D,C,B;u=typeof r;if(u=="string"||u=="number"){r=Num(r)}if(r==null){return{str:""}}t=(r.gte(0))?1:-1;E=r.abs();F=r.abs();if(z){B=Math.abs(z.ticks[z.ticks.length-1].value)}else{B=F}if(typeof B.toValue==="function"){B=B.toValue()}D=["y","d","h","m","s"];y={y:86400*365.25,d:86400,h:3600,m:60,s:1};A="";C={};for(x=0;x<D.length;x++){w=D[x];o=y[w];C[w]=Number(F.div(o).round(0,0));F=F.minus(C[w]*o)}if(F.gt(0)){C.f=F.toString();C.f=C.f.substr(C.f.indexOf("."))}A="";if(C.y>0){A=C.y+"y"}if(C.d>0){A+=(A?" ":"")+C.d+"d"}if(C.h>0||C.m>0||E.gt(y.d)){A+=(A?" ":"")+f(C.h,2)+":"}if(C.m>0||C.h>0||E.gt(y.d)){A+=""+f(C.m,2)}if(C.s>0||C.f){A+=(B>y.m||B>y.h||E.gt(y.d)?":":"")+(B>y.s?f(C.s,2):C.s)}if(C.f){A+=C.f}return{str:(t<0?"-":"")+A}}},locale:{title:"Locale",scale:1,absolute:true,formatLabel:function(r,o){return{str:(new Date(d(r,o.input,"unix"))).toLocaleString()}}},iso:{title:"ISO8601",scale:1,absolute:true,formatLabel:function(u,r){var w={str:"?"};var t=d(u,r.input,r.output);if(r.spacing.name=="days"){t=t.replace(/^([0-9]{4}-[0-9]{2}-[0-9]{2}).*/,function(o,v){return v})}w.str=t.replace(/\.0+Z/,"Z");return w}},jd:{title:"Julian date",scale:86400,absolute:true,formatLabel:function(r,o){return{str:d(r,o.input,o.output)+""}}},mjd:{title:"Modified Julian date",scale:86400,absolute:true,formatLabel:function(r,o){return{str:d(r,o.input,o.output)+""}}},tjd:{title:"Truncated Julian date",scale:86400,absolute:true,formatLabel:function(r,o){return{str:d(r,o.input,o.output)+""}}},unity:{title:"Phase (unity)",phase:true,scale:1,formatLabel:function(r,o){return{str:r+""}}},degrees:{title:"Phase (degrees)",phase:true,scale:1,steps:[{name:"millidegrees",div:0.001/360,spacings:[1,2,5,10,20,50,100,200,500]},{name:"degrees",div:1/360,spacings:[1,2,5,10,15,20,30,60,90,120,180,360]},],formatLabel:function(r,o){return{str:Math.round(r*360)+"°"}}},radians:{title:"Phase (radians)",phase:true,scale:1,steps:[{name:"millirad",div:0.001/Math.PI,spacings:[1,2,5,10,20,50,100,200,500]},{name:"radians",div:1/Math.PI,spacings:[1,Math.PI/2,2,Math.PI]},],formatLabel:function(t,o){var u=(t*2*Math.PI)+"";u=u.replace(/(\.[0-9]+[1-9])[0]{6,}[1-9]*/,function(r,v){return v}).replace(/(\.[0-9]+[0-8])[9]{6,}[0-8]*/,function(r,w){var v=(w.length-1);return parseFloat(w).toFixed(v)}).replace(/^0+([0-9]+\.)/g,function(r,v){return v});return{str:u+"π"}}}};this.datasets=[];this.directory="";for(var q in n){if(n[q]){if(q=="directory"){this[q]=n[q]}if(q=="fit"||q=="tooltip"){this.options[q]=n[q]}}}if(this.json){this.processJSON(p)}return this}b.prototype.processJSON=function(p){this.json=g(p);this.vega=g(p);this.log.message("processJSON",p,this.json);if(p.width){this.options.width=p.width}if(p.height){this.options.height=p.height}if(p.padding){this.options.padding=p.padding}if(p.axes){for(var n=0;n<p.axes.length;n++){var o="";if(p.axes[n].orient=="bottom"){o="xaxis"}if(p.axes[n].orient=="left"){o="yaxis"}if(o){this.options[o]=p.axes[n]}}}return this};b.prototype.initialize=function(q,r){this.log.message("initialize",q);if(typeof r==="function"){this.callback=r}if(!q){this.log.error(q,r)}var o=S(q);if(o.length==0){this.log.error("No DOM element to attach to",q);return this}this.el=q;var p=o.attr("vega-src");if(p){this.file=p}if(!this.file){this.file=""}if(typeof this.file!=="string"){return this}if(typeof this.initializedValues==="undefined"){this.initializedValues={w:q.clientWidth,h:q.clientHeight}}if(this.file){var n=this.file.lastIndexOf("/");this.directory=(n>=0)?this.file.substr(0,n+1):"";S().ajax(this.file,{dataType:"json","this":this,cache:true,success:function(u,t){this.processJSON(u);this.postProcess();return this},error:function(u,t){this.error("Unable to load configuration",t.url,u)}})}else{this.postProcess();return this}return this};b.prototype.postProcess=function(){this.log.message("postProcess",this);this.log.time("postProcess");var w,o,r,n,q,x,t,u,y;if(this.json){var p,v;if(!this.json._extend){this.json._extend={}}if(!this.json._views){this.json._views=[]}x=0;for(q=0;q<this.json.marks.length;q++){if(!this.json.marks[q].name){this.json.marks[q].name="fake-id-"+x;this.log.warning("No name for mark "+q+" so naming it "+this.json.marks[q].name)}x++}if(this.json._extend.marks){for(q=0;q<this.json._extend.marks.length;q++){if(!this.json._extend.marks[q].name){this.json._extend.marks[q].name="fake-id-"+x;this.log.warning("No name for mark "+q+" so naming it "+this.json._extend.marks[q].name)}x++}}p=false;for(q=0;q<this.json._views.length;q++){if(this.json._views[q].name=="default"){p=true;v=g(this.json._views[q])}}if(!p){v={name:"default",title:(this.json.title||"Default"),description:(this.json.description||"The initial view"),markers:[],}}if(!v.scales){v.scales=g(this.json.scales)}if(!v.axes){v.axes=g(this.json.axes)}if(!v._extend){v._extend=g(this.json._extend)}if(!p){for(q=0;q<this.json.marks.length;q++){v.markers.push({name:this.json.marks[q].name,include:true,visible:true})}this.json._views.unshift(v)}this._view=v}if(this.options.fit){this.options.width=this.initializedValues.w;this.options.height=this.initializedValues.h}this.options.logging=this.log.logging;this.options.logtime=this.log.logtime;this.options.scrollWheelZoom=true;if(this.json.scales){for(w=0;w<this.json.axes.length;w++){for(q=0;q<this.json.scales.length;q++){if(this.json.axes[w].scale==this.json.scales[q].name){o=(this.json.axes[w].orient=="left"?"yaxis":"xaxis");this.options[o].type=(this.json.scales[q].type||(o=="xaxis"?"utc":"linear"));this.options[o].padding=(this.json.scales[q].padding||0);if(this.json.scales[q].range){this.options[o].range=this.json.scales[q].range}if(this.json.scales[q].domain){this.options[o].domain=g(this.json.scales[q].domain);for(r=0;r<this.options[o].domain.length;r++){if(this.options[o].domain[r].signal){this.options[o].domain[r]=c(this.options[o].domain[r].signal)}}}}}if(this._view._extend.scales){for(y=0;y<this._view._extend.scales.length;y++){if(this.json.axes[w].scale==this._view._extend.scales[y].name){o=(this.json.axes[w].orient=="left"?"yaxis":"xaxis");this.options[o].highprecision=(this._view._extend.scales[y].highprecision||false)}}}}}this.graph=new Graph(this.el,[],this.options);n=S(this.el);u='<div class="loader"><div class="spinner">';for(q=1;q<6;q++){u+='<div class="rect'+q+' seasonal"></div>'}u+="</div></div>";n.addClass("timeseries").append(u);t=this;this.makeMenu();if(this.json){this.loadDatasets(this.json.data)}this.log.time("postProcess");return this};b.prototype.updateMessage=function(r,p,n,q){var o=S(this.el).find(".loader");if(!r){o.html("");return this}if(!this.message){this.message={}}r=this.el.getAttribute("id")+"-"+r;if(!this.message[r]){o.append('<div id="'+r+'"><div class="loader-message"></div></div>');o=o.find("#"+r);this.message[r]={el:o,message:o.find(".loader-message")}}if(p||(typeof n==="number"&&n<=100)){if(this.message[r].message.length>0){this.message[r].message[0].innerHTML=p}if(typeof n==="number"&&n<=100){if(!this.message[r].progress){this.message[r].el.append('<div class="progressbar"><div class="progress-inner"></div></div>');this.message[r].progress=this.message[r].el.find(".progress-inner")}this.message[r].progress.css({width:n+"%"});if(q){this.message[r].progress.css({background:q})}}}else{this.message[r].el.remove()}return this};b.prototype.makeMenu=function(){var p,t,o,r,n,q;p=S(this.el);t=p.attr("id");if(p.find(".menuholder").length==0){q=[{key:"views",title:"Views",html:'<ol class="views"></ol>'},{key:"layers",title:"Marker layers",html:'<ol class="layers"></ol>',on:true},{key:"config",title:"Options",html:'<div class="row"><button class="fullscreen icon" title="Toggle fullscreen">'+i("fit")+'</button><button class="autozoom">Reset view</button></div><div class="row"><button class="fontup">A&plus;</button><button class="fontreset">A</button><button class="fontdn">A&minus;</button></div>'},{key:"save",title:"Save",html:'<button class="savepng" data="white">Save as PNG</button><button class="savepng">Save as transparent PNG</button><button class="savevega">Save as JSON (VEGA-compatible)</button><button class="editvega">Open selected view in VEGA</button><br style="clear:both;">'}];r="";n="";for(o=0;o<q.length;o++){r+='<li class="submenu-'+q[o].key+'"><button '+(q[o].on?'class="on" ':"")+'data="submenu-'+q[o].key+'" title="'+q[o].title+'">'+i(q[o].key,"white")+"</button></li>";n+=(q[o].html?'<div class="menu-panel submenu-'+q[o].key+(q[o].on?" on":"")+'">'+q[o].html+"</div>":"")}r+="<li></li>";p.prepend('<div class="menuholder"><input type="checkbox" id="'+t+'_hamburger" class="hamburger"><label for="'+t+'_hamburger" class="hamburger">'+i("menu","white")+'<span class="nv">Toggle menu (if not visible)</span></label><menu class="timeseries-actions-wrapper"><ul class="submenu">'+r+"</ul>"+n+"</menu></div>");for(o=0;o<q.length;o++){if(q[o].on){p.find("submenu-"+q[o].key).addClass("on")}}p.find(".menuholder").on("mouseover",function(){S(".graph-tooltip").css({display:"none"})});p.find("#"+t+"_hamburger").on("click",{me:this},function(v){var u=(this[0].checked?0:-1);this.parent().find("menu button, menu a").attr("tabIndex",u)});p.find("button.fullscreen").on("click",{g:this.graph},function(u){u.data.g.toggleFullScreen()});p.find("button.autozoom").on("click",{g:this.graph},function(u){u.data.g.zoom()});p.find("button.fontup").on("click",{g:this.graph},function(u){u.data.g.scaleFont(+1)});p.find("button.fontdn").on("click",{g:this.graph},function(u){u.data.g.scaleFont(-1)});p.find("button.fontreset").on("click",{g:this.graph},function(u){u.data.g.scaleFont(0)});p.find("button.savevega").on("click",{me:this},function(u){u.data.me.save("vega")});p.find("button.editvega").on("click",{me:this},function(u){u.data.me.save("vegaeditor")});p.find("button.savepng").on("click",{me:this},function(u){u.data.me.save("png",{background:S(u.currentTarget).attr("data")})});p.find(".submenu button").on("click",{el:p},function(w){w.data.el.find(".on").removeClass("on");var v=S(w.currentTarget);var u=v.attr("data");v.addClass("on");w.data.el.find(".menu-panel."+u).addClass("on")})}return this};b.prototype.loadDatasets=function(u){this.log.message("loadDatasets",u);this.log.time("loadDatasets");if(!u){return this}this.updateMessage("main","Loading data...");if(u.length==0){S(this.el).find(".loader").html("&#9888; No data defined");return this}this.datasets={};var v,t,r,q,p,o;v=u.length;t="";r=[];this.progress.datasets={todo:v,done:0};q=function(y,n){var w;var x="json";if(n&&n.dataset&&n.dataset.format&&n.dataset.format.type=="csv"){x="csv"}if(x=="csv"){w=k(y,n.dataset.format.parse)}else{if(x=="json"){w=y[0]}}this.datasets[n.dataset.name]={json:w,parse:n.dataset.format.parse};this.datasets[n.dataset.name][x]=y;this.progress.datasets.done++;this.log.message("loaded dataset",n.dataset.name);if(this.progress.datasets.done==this.progress.datasets.todo){this.processDatasets()}};for(p=0;p<v;p++){if(u[p].url){r.push(this.directory+u[p].url)}}this.log.message("files",r);for(p=0;p<v;p++){if(u[p].values){q.call(this,u[p].values,{dataset:u[p],files:r})}}for(o=0;o<r.length;o++){TimeSeries.loadFromDataFile(r[o],{"this":this,dataset:u[o],files:r},q)}this.updateMessage("main","");this.log.time("loadDatasets");return this};b.prototype.updateLayerMenu=function(){var D,C,y,r,o,A,x,B,v,E,u,F,K,q,H,J,z,G,t,I,n;o=this.graph.canvas.container.find(".layers");o.find("li").remove();q={};H={};for(D in this.graph.marks){if(this.graph.marks[D]){y=S(this.el).attr("id")+"_"+D;K=this.graph.marks[D].desc;if(this.graph.marks[D].include){if(typeof q[K]==="undefined"){q[K]=[]}q[K].push(D)}}}C=0;for(K in q){if(q[K]){if(typeof q[K]!=="undefined"){y=S(this.el).attr("id")+"_"+C;F=this.graph.marks[q[K][0]];o.append('<li><input type="checkbox" checked="checked" id="'+y+'" data="'+K+'" /><label for="'+y+'"><span class="key" style="background-color:'+F.format.fill+";"+(F.type=="area"&&F.format.fillOpacity?"opacity:"+F.format.fillOpacity+";":"")+'">?</span>'+K+"</label></li>");A=o.find("#"+y);x=A.parent();B=x.find(".key");A.on("change",{me:this,k:q[K]},function(M){var L,w,p;L=M.data.me.graph;for(w=0;w<M.data.k.length;w++){p=M.data.k[w];L.marks[p].show=!L.marks[p].show}L.calculateData().draw(true);if(this.parent().find("input")[0].checked){this.parent().removeClass("inactive")}else{this.parent().addClass("inactive")}}).on("focus",{layers:o},function(p){p.data.layers.find("li").removeClass("on").removeClass("selected");this.parent().addClass("on")});o.on("mouseover",{layers:o},function(p){p.data.layers.find(".selected").removeClass("selected")});H[q[K][0]]=A.parent();u=false;for(D=0;D<q[K].length;D++){if(["symbol","rect","line","rule","text","area"].indexOf(F.type)>=0){u=true}}if(u&&B.length==1){r=window.getComputedStyle(B[0]);v=parseInt(r.width);E=parseInt(r.height);B.html('<canvas style="width:'+v+"px;height:"+E+'px;"></canvas>')}if(x.find("canvas").length==1){G=x.find("canvas")[0];v=parseInt(x.find("canvas").css("width"));E=parseInt(x.find("canvas").css("height"));z=G.getContext("2d");J=window.devicePixelRatio;G.width=v*J;G.height=E*J;z.scale(J,J);z.clearRect(0,0,v,E);z.fillStyle="#ffffff";z.rect(0,0,v,E);z.fill();for(D=0;D<q[K].length;D++){F=this.graph.marks[q[K][D]];if(F.include){B.css({"background-color":"none"});this.graph.setCanvasStyles(z,F.mark[0]);if(F.type=="symbol"){this.graph.drawShape(g(F.mark[0]),{ctx:z,x:v/2,y:E/2})}else{if(F.type=="rect"){if(F.mark[0].props.x1&&F.mark[0].props.x2&&F.mark[0].props.y1&&F.mark[0].props.y2){this.graph.drawRect(g(F.mark[0]),{ctx:z,x1:0,y1:0,x2:v,y2:E})}else{this.graph.drawRect(g(F.mark[0]),{ctx:z,x1:v/2,y1:0,x2:v/2,y2:E})}}else{if(F.type=="area"){this.graph.drawRect(g(F.mark[0]),{ctx:z,x1:0,y1:0,x2:v,y2:E})}else{if(F.type=="line"){z.beginPath();z.moveTo(0,E/2);z.lineTo(v,E/2);z.lineWidth=(F.encode.enter.strokeWidth.value||0.8);z.stroke()}else{if(F.type=="rule"){z.beginPath();z.lineWidth=(F.encode.enter.strokeWidth.value||1);if(F.data[0].y.value==F.data[0].y2.value){z.moveTo(0,E/2+0.5);z.lineTo(v,E/2+0.5)}else{if(F.data[0].x.value==F.data[0].x2.value){z.moveTo(v/2+0.5,0);z.lineTo(v/2+0.5,E)}else{z.moveTo(0,0);z.lineTo(v,E)}}z.stroke()}else{if(F.type=="text"){this.graph.drawTextLabel("T",v/2,E/2,{ctx:z,format:{align:"center",baseline:"middle"}})}}}}}}}}}n=false;I=false;for(D=0;D<q[K].length;D++){if(this.graph.marks[q[K][D]].include){n=true}if(this.graph.marks[q[K][D]].show){I=true}}t=o.find("#"+y).parent();t.css({display:(n?"block":"none")});if(I){t.removeClass("inactive")}else{t.addClass("inactive")}C++}}}this.graph.on("hoverpoint",{lookup:H,layers:o},function(w){w.data.layers.find("li").removeClass("selected");if(w.matches.length==0){return}for(var p=0;p<w.matches.length;p++){if(w.data.lookup[w.matches[p].series]){w.data.lookup[w.matches[p].series].addClass("selected")}}});return this};b.prototype.getViews=function(){var n,p,o;n=[];o=this.json._views;for(p=0;p<o.length;p++){n.push({title:(o[p].title||""),name:(o[p].name||""),description:(o[p].description||"")})}return n};b.prototype.setView=function(u){var v,t,y,z,w,r,p,D,B,A,q,C,n,x;t=this.json;if(typeof u!=="number"){x=JSON.stringify(u);for(r=0;r<t._views.length;r++){if(JSON.stringify(t._views[r])==x){u=r;continue}}if(typeof u!=="number"){this.log.error("Invalid view number provided: "+u);return this}}if(typeof u!=="number"){this.log.error("Invalid view index provided: "+u);return this}if(u>=t._views.length){this.log.error("The maximum index is "+(t._views.length-1)+"");return this}for(r=0;r<t._views.length;r++){t._views[r].active=(u==r)}y=g(t._views[u]);p={};for(z=0;z<t.axes.length;z++){if(y.scales){for(D=0;D<y.scales.length;D++){if(t.axes[z].scale==y.scales[D].name){q=(t.axes[z].orient=="left"?"yaxis":"xaxis");if(typeof p[q]!=="object"){p[q]={}}p[q].type=(q=="xaxis"?"utc":"linear");p[q].padding=0;if(y.scales[D]){if(typeof y.scales[D].type!=="undefined"){p[q].type=y.scales[D].type}if(typeof y.scales[D].padding!=="undefined"){p[q].padding=y.scales[D].padding}}if(y.scales[D].range||t._views[0].scales[D].range){p[q].range=g(y.scales[D].range||t._views[0].scales[D].range)}if(t._views[0].scales[D].domain||y.scales[D].domain){p[q].domain=g(y.scales[D].domain||t._views[0].scales[D].domain);for(w=0;w<p[q].domain.length;w++){if(p[q].domain[w].signal){p[q].domain[w]=c(p[q].domain[w].signal)}}}}}}if(y.axes){q=(t.axes[z].orient=="left"?"yaxis":"xaxis");p[q].title=(typeof y.axes[z].title!=="undefined"?y.axes[z].title:"")}}this._view=y;v=this.graph;v.setOptions(p);for(r in v.marks){if(v.marks[r]){C=-1;v.marks[r].include=false;for(D=0;D<y.markers.length;D++){if(v.marks[r].name==y.markers[D].name){C=D;v.marks[r].include=true;v.marks[r].show=y.markers[D].visible}}}}this.updateLayerMenu();v.updateData();n=v.canvas.container.find(".views");B=n.find("li");for(r=0;r<B.length;r++){A=S(B[r]);if(u==r){A.addClass("selected").find("input").attr("checked","checked")}else{A.removeClass("selected").find("input").attr("checked","")}}this.updateOptionsMenu();return this};b.prototype.updateViewMenu=function(){var p,o,q,u,n,t,r;r="abcdefghijklmnopqrstuvwxyz";q=this.graph.canvas.container.find(".views");n=this.graph.canvas.container.find(".submenu-views");if(this.json._views.length<2){q.css({display:"none"});n.css({display:"none"});return this}else{q.css({display:""});n.css({display:""})}t=0;for(p=0;p<this.json._views.length;p++){if(this.json._views[p].active){t=this.json._views[p].active}}this.json._views[t].active=true;for(p=0;p<this.json._views.length;p++){u=S(this.el).attr("id")+"-view-"+p;if(q.find("#"+u).length==0){q.append("<li "+(this.json._views[p].active?' class="selected"':"")+'><input type="radio"'+(this.json._views[p].active?' checked="checked"':"")+' id="'+u+'" name="'+S(this.el).attr("id")+'-view" data="'+p+'" /><label for="'+u+'" title="'+this.json._views[p].description+'"><span style="font-family:monospace;">'+r.substr(p,1).toUpperCase()+".</span> "+this.json._views[p].title+"</label></li>");o=q.find("#"+u);o.on("change",{me:this,id:u,i:p,el:q},function(v){v.data.me.setView(v.data.i)}).on("focus",{el:q},function(v){v.data.el.find("li").removeClass("on");this.parent().addClass("on")})}}return this};b.prototype.updateOptionsMenu=function(){var o=S(this.el);var n=o.attr("id");if(o.find("#"+n+"_dateformat").length>0){o.find("#"+n+"_dateformat").parent().remove()}if(this._view._extend&&this._view._extend.scales){var t,q,p,w,v,r,u;for(w=0;w<this._view._extend.scales.length;w++){if(this._view._extend.scales[w].name=="xscale"){q="absolute";if(this._view._extend.scales[w].input=="phase"){q="phase"}else{if(this._view._extend.scales[w].input=="seconds"){q="relative"}}if(q=="phase"){t=(this._view._extend.scales[w].output||"unity");v="Phase format"}else{t=(this._view._extend.scales[w].output||"auto");v="Date format"}r='<div class="row"><label for="'+n+'_dateformat">'+v+': </label><select id="'+n+'_dateformat">';u=false;for(p in this.xformats){if(this.xformats[p]&&this.xformats[p][q]){r+='<option value="'+p+'"'+(p==t?' selected="selected"':"")+">"+this.xformats[p].title+"</option>";if(t&&this.xformats[t]&&p==t){this.setDateFormat(t)}if(p==t){u=true}}}if(!u){this.log.error(t+" is not an available format")}r+="</select></div>";o.find(".menu-panel.submenu-config").append(r);o.find("#"+n+"_dateformat").on("change",{me:this},function(x){x.data.me.setDateFormat(this[0].value,true)})}}}return this};b.prototype.setDateFormat=function(p,q){if(this._view._extend.scales){for(s=0;s<this._view._extend.scales.length;s++){if(this._view._extend.scales[s].name=="xscale"){var n=this._view._extend.scales[s].input;if(this.xformats[p]){this.graph.x.labelopts=this.xformats[p];this.graph.x.isDate=(this.xformats[p].absolute?true:false);this.graph.x.isPhase=(this.xformats[p].phase?true:false);this.graph.x.labelopts.input=n;this.graph.x.labelopts.output=p;this.graph.x.labelopts.inputscale=(this.xformats[n]?this.xformats[n].scale:1);this.graph.defineAxis("x",this.graph.x.min,this.graph.x.max).calculateData().draw(q)}else{if(!this.xformats[n]){this.log.error("Input format "+n+" is not a known date format")}if(!this.xformats[p]){this.log.error("Output format "+p+" is not a known date format")}}return this}}}};b.prototype.processDatasets=function(){this.log.message("processDatasets",this.attr.showaswego,this.graph.marks);this.log.time("processDatasets");var v,q,u,t,z,w,p,r,x;if(!this.progress.marks){this.progress.marks={todo:0,done:0,mark:{}}}p=[this.json.marks];if(this.json._extend.marks){p.push(this.json._extend.marks)}for(t=0,r=0;t<p.length;t++){for(v=0;v<p[t].length;v++){if(!p[t][v].name){this.log.error("No name for "+p[t][v].title+" ("+v+")")}else{this.progress.marks.mark[p[t][v].name]={done:-1,todo:0}}r++}}this.progress.datasets.old=this.progress.datasets.used;x=this;function y(F,B){var G,E;var n={size:"props",shape:"props",fill:"props",fillOpacity:"props",stroke:"props",strokeOpacity:"props",strokeWidth:"props",strokeCap:"props",strokeDash:"props",width:"props",height:"props",tooltip:"props",font:"props",fontSize:"props",fontWeight:"props",fontStyle:"props",baseline:"props",align:"props",dx:"props",angle:"props",limit:"props"};if(!F){x.log.message("updateProps fail",F,B);return}datum=F.data;for(var D in B){if(B[D]){if(n[D]&&n[D]=="props"){if(typeof B[D].value!=="undefined"){if(F.props.symbol){F.props.symbol[D]=B[D].value}if(F.props.format){F.props.format[D]=B[D].value}}}else{if(typeof datum[D]==="undefined"){datum[D]=g(B[D])}if(B[D].field){if(typeof B[D].field==="string"){if(typeof datum[B[D].field]!=="undefined"){F.data[D]=datum[B[D].field]}}else{if(typeof B[D].field==="object"){F.data[D]=g(B[D])}}}if(typeof B[D].value!=="undefined"){if(B[D].format&&B[D].format=="date"){datum[D].value=(new Date(B[D].value)).getTime()/1000}else{datum[D].value=B[D].value}}}if(B[D].signal){G=n[D]||"data";if(typeof F[G][D]==="undefined"){F[G][D]={}}try{F[G][D].value=c(B[D].signal,datum)}catch(C){x.log.error(F.data,B[D])}if(D=="tooltip"){if(typeof F.props[D].value==="object"){E="<table>";for(var A in F.props[D].value){if(typeof F.props[D].value[A]!=="undefined"){E+="<tr><td>"+A+":</td><td>"+F.props[D].value[A]+"</td></tr>"}}F.props[D]=E+"</table>"}else{F.props[D]=F.props[D].value}}}}}return F}function o(B,A,F,n){var E="";if(F.from&&F.from.data){E=F.from.data;if(B.datasets[E]){B.progress.datasets.used+=E}}if((!E||B.datasets[E])&&!B.graph.marks[A]){var D=F.description||"Markers "+(A+1);var C={title:E,id:E,name:(F.name||""),desc:D,type:F.type,interactive:(typeof F.interactive==="boolean"?F.interactive:true),css:{"background-color":"#000000"},include:(typeof F.include==="boolean"?F.include:true)};if(F.type=="symbol"){C.symbol={show:true}}else{if(F.type=="rect"){C.rect={show:true}}else{if(F.type=="line"){C.lines={show:true}}else{if(F.type=="rule"){C.rule={show:true}}else{if(F.type=="area"){C.area={show:true}}else{if(F.type=="text"){C.text={show:true}}}}}}}if(B.datasets[E]){C.data=g(B.datasets[E].json);C.parse=B.datasets[E].parse}else{C.data=[{props:{x:0,y:0,x2:0,y2:0}}];C.parse={}}if(C){if(F.encode&&F.encode.hover){C.hoverable=true;if(F.encode.hover.fill){C.css["background-color"]=F.encode.hover.fill.value}}C.encode=F.encode;if(F.encode.enter){C.enter=function(G,H){return y(G,H)}}if(F.encode.update){C.update=function(G,H){return y(G,H)}}if(F.encode.hover){C.hover=function(G,H){return y(G,H)}}C.clip=(F.clip||false);B.graph.addMarks(C,A,F,n);if(B.datasets[E]){B.datasets[E].added=true}}else{B.log.message("No dataset built for "+E,F)}}return B}for(q in this.datasets){if(this.datasets[q]&&!this.datasets[q].data){this.datasets[q].data=this.datasets[q].json}}this.graph.addDatasets(this.datasets);this.progress.marks.todo=this.json.marks.length+(this.json._extend.marks?this.json._extend.marks.length:0);z=function(n){this.progress.marks.done++;this.progress.marks.mark[n.name].done=n.i;this.progress.marks.mark[n.name].todo=n.total;this.log.message("Processed "+n.name,this.progress.marks.mark[n.name]);this.updateMessage(n.name,"");if(this.attr.showaswego){this.graph.updateData()}if(this.progress.marks.done==this.progress.marks.todo){this.finalize()}};w=function(n){this.progress.marks.mark[n.mark.name].done=n.i;this.progress.marks.mark[n.mark.name].todo=n.total;this.updateMessage(n.mark.name,"Processing "+(n.mark.description||n.mark.name),100*n.i/n.total,(n.mark.encode&&n.mark.encode.update&&n.mark.encode.update.fill?n.mark.encode.update.fill.value:""));return this};this.updateMessage("main","");for(t=0;t<this.json.marks.length;t++){u=g(this.json.marks[t]);if(this.progress.marks.mark[u.name].done<=0){this.progress.marks.mark[u.name].done=0;o(this,t,u,{"this":this,success:z,progress:w})}}if(this.json._extend.marks){for(t=0;t<this.json._extend.marks.length;t++){u=this.json._extend.marks[t];u.include=false;o(this,t+this.json.marks.length+t,g(u),{"this":this,success:z,progress:w})}}for(t in this.graph.marks){if(this.graph.marks[t]){for(v=0;v<this._view.markers.length;v++){if(this.graph.marks[t].name==this._view.markers[v].name){if(!this._view.markers[v].visible){this.graph.marks[t].show=false}}}}}if(this.progress.datasets.used!=this.progress.datasets.old&&this.attr.showaswego){this.graph.updateData()}this.log.time("processDatasets");return this};b.prototype.finalize=function(){this.log.message("finalize",this.attr.showaswego,this.graph.marks);this.updateMessage("main","");if(this.attr.showaswego==false){this.graph.updateData()}this.graph.canvas.container.find(".loader").remove();this.updateLayerMenu();this.updateViewMenu();this.updateOptionsMenu();if(typeof this.callback==="function"){this.callback.call(this)}this.log.info("Finished processing "+this.el.getAttribute("id"));return this};b.prototype.save=function(x,v){if(typeof Blob!=="function"){return this}var t,u,C,y,n,q,o;n={type:"text/text",file:(this.file?this.file.replace(/.*\//g,""):"timeseries.json")};if(!v){v={}}function w(G){var D=new Blob([G],{type:n.type});function E(H){document.body.removeChild(H.target)}var F=document.createElement("a");F.download=n.file;F.innerHTML="Download File";if(window.webkitURL!=null){F.href=window.webkitURL.createObjectURL(D)}else{F.href=window.URL.createObjectURL(D);F.onclick=E;F.style.display="none";document.body.appendChild(F)}F.click()}if(x=="vega"||x=="vegaeditor"){o=g(this.vega);for(t=0;t<o.data.length;t++){delete o.data[t].url;q="json";if(this.datasets[o.data[t].name].csv){q="csv"}o.data[t].values=this.datasets[o.data[t].name][q]}if(x=="vegaeditor"){y=this._view;var z=[];var r={};var B,p;for(p=0;p<y.markers.length;p++){B=false;for(C=0;C<this.json.marks.length;C++){if(!r[y.markers[p].name]&&this.json.marks[C].name==y.markers[p].name){z.push(g(this.json.marks[C]));r[y.markers[p].name]=true}}if(!r[y.markers[p].name]&&this.json._extend&&this.json._extend.marks){for(C=0;C<this.json._extend.marks.length;C++){if(!r[y.markers[p].name]&&this.json._extend.marks[C].name==y.markers[p].name){z.push(g(this.json._extend.marks[C]));r[y.markers[p].name]=true}}}}o.marks=z;if(y.scales){o.scales=y.scales}if(y.axes){o.axes=y.axes}if(y.title){o.title=y.title}delete o._extend;delete o._views}u=JSON.stringify(o)}if(x=="vega"){n.type="text/json";n.file=(this.file?this.file.replace(/.*\//g,""):(v.file||"timeseries.json"));w(u)}if(x=="vegaeditor"){var A=window.open("https://vega.github.io/editor/#/","VEGA","");setTimeout(function(){A.postMessage({mode:"vega",spec:u,config:{axisY:{minExtent:30}},renderer:"svg"},"https://vega.github.io")},1000)}if(x=="png"){if(v&&v.background){this.graph.background=v.background;this.graph.clear().drawAxes().resetDataStyles().drawData(false)}n.type="image/png";n.file=(v.file||"timeseries.png");this.graph.canvas.c.toBlob(w,n.type);if(v){this.graph.background="";this.graph.clear().drawAxes().resetDataStyles().drawData(false)}}return this};b.prototype.error=function(p,n,o){this.log.error(p,n,o,"fred");if(S(this.el).find(".loader").length==0){S(this.el).html('<div class="loader"><div class="spinner"></div></div>').css({position:"relative",width:"100%",height:"200px"})}if(S(this.el).find(".spinner").length>0){S(this.el).find(".loader").html("&#9888; "+p);this.remove()}S(this.el).find(".loader").append("<br />"+n+"");return this};b.prototype.remove=function(){S(this.el).find(".menuholder").remove();S(this.el).find(".canvasholder").remove();return{}};function i(o,p){var n={menu:'<path style="fill:%COLOUR%;fill-opacity: 0.8;" d="M 5,6 l 22,0 0,4 -22,0 0,-4 M 5,14 l 22,0 0,4 -22,0 0,-4 M 5,22 l 22,0 0,4 -22,0 0,-4 " />',fit:'<path style="fill:%COLOUR%" d="M 0,12 L0,0 12,0 12,4 6,4 12,10 10,12 4,6 4,12 M20,0 L 32,0 32,12 28,12 28,6 22,12 20,10 26,4 20,4 20,0 M 20,32 L20,28 26,28 20,22 22,20 28,26 28,20 32,20, 32,32 20,32 M 12,32 L 0,32 0,20 4,20 4,26 10,20 12,22 6,28 12,28 12,32" />',layers:'<path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 16,6 l 12,6.5 -12,6.5 -12,-6.5Z" /><path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 16,10.5 l 12,6.5 -12,6.5 -12,-6.5 Z" /><path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 16,15 l 12,6.5 -12,6.5 -12,-6.5 Z" />',views:'<path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 5,5 l 10,0 0,10 -10,0 0,-2 4,0 0,-2.5 2,0 0,2.5 1,0 0,-5 -1,-1 -2,0 -1,1 3,0 0,1.5 -2,0 0,-1.5 -1,0 0,5 -3,0Z M 17,5 l 10,0 0,10 -10,0 0,-2 6,0 1,-1 0,-1 -1,-1 1,-1 0,-1 -1,-1 -2,0 0,1 2,0 0,1 -0.5,0.5 -1.5,0 0,1 1.5,0 0.5,0.5 0,1 -2,0 0,-5 -1,0 0,6 -3,0Z M 5,17 l 10,0 0,10 -10,0 0,-2 4,0 3,0 0,-1 -3,0 0,-4 3,0 0,-1 -3,0 -1,1 0,4 1,1 -4,0Z M 17,17 l 10,0 0,10 -10,0 0,-2 6,0 1,-1 0,-4 -1,-1 -3,0 0,1 3,0 0,4 -2,0 0,-4 -1,0 0,5 -3,0Z" />',config:'<path style="fill:%COLOUR%;fill-opacity:0.8;" d="M 13.971 4.5996 L 13.377 7.6992 L 13.453 7.6992 A 8.661 8.661 0 0 0 12.008 8.291 L 9.4785 6.5 L 6.5781 9.4004 L 8.3926 11.865 A 8.661 8.661 0 0 0 7.707 13.551 L 7.707 13.4 L 4.6074 13.9 L 4.6074 18 L 7.707 18.5 L 7.707 18.361 A 8.661 8.661 0 0 0 8.3945 20.033 L 6.5781 22.5 L 9.4785 25.4 L 12.01 23.609 A 8.661 8.661 0 0 0 13.395 24.189 L 13.971 27.199 L 18.033 27.199 L 18.547 24.215 A 8.661 8.661 0 0 0 20.014 23.621 L 22.529 25.4 L 25.43 22.5 L 23.635 20.059 A 8.661 8.661 0 0 0 24.289 18.496 L 27.369 18 L 27.369 13.9 L 24.283 13.402 A 8.661 8.661 0 0 0 23.631 11.848 L 25.43 9.4004 L 22.529 6.5 L 20.01 8.2832 A 8.661 8.661 0 0 0 18.564 7.6836 L 18.033 4.5996 L 13.971 4.5996 z M 15.988 10.828 A 5.0719 5.0719 0 0 1 21.061 15.9 A 5.0719 5.0719 0 0 1 15.988 20.973 A 5.0719 5.0719 0 0 1 10.916 15.9 A 5.0719 5.0719 0 0 1 15.988 10.828 z" />',save:'<path style="fill:%COLOUR%;fill-opacity: 0.8;" d="M 6,26 l 20,0 0,-6 -6,0 -4,3 -4,-3 -6,0 Z M 16,20 l 8,-8 -5,0 0,-6 -6,0 0,6 -5,0" />'};return'<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">'+(n[o]||"").replace(/%COLOUR%/g,(p||"black"))+"</svg>"}function a(p,n){n=(n||",");var u=new RegExp(("(\\"+n+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+n+"\\r\\n]*))"),"gi");var t=[[]];var r=false;while(r=u.exec(p)){var q=r[1];if(q.length&&q!==n){t.push([])}var o;if(r[2]){o=r[2].replace(new RegExp('""',"g"),'"')}else{o=r[3]}t[t.length-1].push(o)}return t}function k(r,u){if(typeof r==="string"){r=a(r)}var o,n,v,p,q;var t=[];n=new Array(r[0].length);v=new Array(r[0].length);for(p=0;p<r[0].length;p++){v[p]=r[0][p];n[p]=u[v[p]]||"string"}for(q=1;q<r.length;q++){if(!r[q]||r[q]==""){continue}o={};for(p=0;p<r[q].length;p++){if(n[p]=="number"){o[v[p]]=parseFloat(r[q][p])}else{o[v[p]]=r[q][p]}}t.push(o)}return t}function f(o,p){if(!p){p=2}o=o+"";while(o.length<p){o="0"+o}return o}var m="function zeroPad(d,n){ if(!n){ n = 2;} d = d+''; while(d.length < n){ d = '0'+d; } return d; };";m+="function timeFormat(t,f){ var d,micros,ds,dl,m,ms,ml; d = new Date(t*1000); micros = ''; m = (t+'').match(/\\.[0-9]{3}([0-9]+)/);if(m && m.length==2){ micros = m[1]; }; ds = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; dl = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']; ms = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; ml = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return f.replace(/%a/g,ds[d.getDay()]).replace(/%Y/g,d.getFullYear()).replace(/%a/g,dl[d.getDay()]).replace(/%b/g,ms[d.getMonth()]).replace(/%B/g,ml[d.getMonth()]).replace(/%d/g,(d.getDate().length==1 ? '0':'')+d.getDate()).replace(/%m/,(d.getMonth()+1)).replace(/%H/,zeroPad(d.getUTCHours())).replace(/%M/,zeroPad(d.getUTCMinutes())).replace(/%S/,zeroPad(d.getUTCSeconds())).replace(/%L/, (zeroPad(d.getUTCMilliseconds(),3)+micros).replace(/([0-9])0+$/,function(m,p1){ return p1; }));};";m+="function datetime(y,m,d,h,mn,sc,ms){ return (new Date(y+'-'+zeroPad(m+1,2)+'-'+(typeof d==='number' ? zeroPad(d,2):'01')+(typeof h==='number' ? 'T'+(zeroPad(h,2)+':'+(typeof mn==='number' ? zeroPad(mn,2)+(typeof sc==='number' ? ':'+zeroPad(sc,2)+(ms ? '.'+zeroPad(ms,3):''):''):'00'))+'Z':''))).valueOf()/1000; }";m+="function date(d){ return (new Date(d)).getTime()/1000; }";function c(p,o){if(typeof o==="object"){for(var n in o){if(typeof o[n]=="object"&&o[n].type=="Num"){o[n]=(typeof o[n].toValue==="function")?o[n].toValue():o[n].v}}}return Function('"use strict";'+m+" return ("+p+")")()}function g(p){var o=JSON.stringify(p);var n=JSON.parse(o);return n}j.AASTimeSeriesEmbed=function(p,o,n){var q=TimeSeries.create(o,n);q.initialize(S(p)[0]);return};function d(q,p,r){if(typeof q==="number"){q=Num(q)}var n=new l(q,p);if(r=="jd"){return n.toJD()}else{if(r=="mjd"){return n.toMJD()}else{if(r=="tjd"){return n.toTJD()}else{if(r=="unix"){return n.toUNIX()}else{if(r=="seconds"){return n.toSeconds()}else{if(r=="iso"){return n.toDate().toISOString()}}}}}}return 0}function l(o,n){this.epoch={jd:2440587.5,mjd:2400000.5,tjd:2440000.5};this.d2ms=86400000;if(typeof o==="number"){o=Num(o)}if(n=="jd"){this.jd=o}if(n=="mjd"){this.jd=o.plus(this.epoch.mjd)}if(n=="tjd"){this.jd=o.plus(this.epoch.tjd)}if(n=="unix"){this.unix=o}if(n=="iso"||n=="locale"){this.unix=o.times(1000)}return this}l.prototype.toJD=function(){if(this.jd){return this.jd.toValue()}if(this.unix){return this.unix.div(this.d2ms).plus(this.epoch.jd).toValue()}return 0};l.prototype.toUNIX=function(){if(this.unix){return this.unix.toValue()}if(this.jd){return this.jd.minus(this.epoch.jd).times(this.d2ms).toValue()}return 0};l.prototype.toSeconds=function(){if(this.unix){return this.unix.div(1000).toValue()}if(this.jd){return this.jd.minus(this.epoch.jd).times(this.d2ms).div(1000).toValue()}return 0};l.prototype.toMJD=function(){if(this.unix){this.jd=this.unix.div(this.d2ms).plus(this.epoch.jd)}if(this.jd){return this.jd.minus(this.epoch.mjd).toValue()}else{return 0}};l.prototype.toTJD=function(){if(this.unix){this.jd=this.unix.div(this.d2ms).plus(this.epoch.jd)}if(this.jd){return this.jd.minus(this.epoch.tjd).toValue()}else{return 0}};l.prototype.toDate=function(){if(this.jd){return new Date(this.toUNIX())}if(this.unix){return new Date(this.unix.toValue())}return new Date()};j.TimeSeries=TimeSeries})(window||this);